<?xml version="1.0"?>

<project name="build-common">
	<property environment="env" />
	<property name="project.dir" location=".." />
	<property file="${project.dir}/app.server.${user.name}.properties" />
	<property file="${project.dir}/app.server.properties" />
	<property file="${project.dir}/build.${user.name}.properties" />
	<property file="${project.dir}/build.properties" />
	<property file="${project.dir}/release.${user.name}.properties" />
	<property file="${project.dir}/release.properties" />
	<path id="project.classpath">
		<pathelement path="${classpath}" />
		<pathelement location="${project.dir}/ws-client/ssf-wsclient.jar"/>
		<fileset dir="${project.dir}/lib" includes="*.jar" />
	</path>
	<taskdef classpathref="project.classpath" resource="net/sf/antcontrib/antcontrib.properties" />
	<taskdef classpathref="project.classpath" resource="axis-tasks.properties" />
	<property name="java2html.dir" value="${api.dir}/${ant.project.name}" />
	<property name="javadoc.dir" value="${api.dir}/${ant.project.name}" />
	<propertycopy name="app.server.dir" from="app.server.${portal.type}.${app.server.type}.dir" />
	<propertycopy name="app.server.server.dir" from="app.server.${portal.type}.${app.server.type}.server.dir" />
	<propertycopy name="app.server.deploy.dir" from="app.server.${portal.type}.${app.server.type}.deploy.dir" />
	<propertycopy name="app.server.shared.lib.dir" from="app.server.${portal.type}.${app.server.type}.shared.lib.dir" />
	<propertycopy name="app.server.lib.dir" from="app.server.${portal.type}.${app.server.type}.lib.dir" />
	<propertycopy name="app.server.ssf.dir" from="app.server.${portal.type}.${app.server.type}.ssf.dir" />
	<propertycopy name="app.server.ssfs.dir" from="app.server.${portal.type}.${app.server.type}.ssfs.dir" />
	
	<target name="clean">
		<delete file="${jar.file}" failonerror="false" />
		<delete dir="${java2html.dir}" />
		<delete dir="${javadoc.dir}" />
		<delete includeEmptyDirs="true" failonerror="false">
			<fileset dir="${classes.dir}" excludes="${classes.dir.excludes}" />
		</delete>
	</target>

	<target name="compile">
		<mkdir dir="${classes.dir}" />
		<javac
			classpathref="project.classpath"
			bootclasspath="${javac.bootclasspath}"
			compiler="${javac.compiler}"
			debug="${javac.debug}"
			deprecation="${javac.deprecation}"
			destdir="${classes.dir}"
			fork="${javac.fork}"
			memoryMaximumSize="${javac.memoryMaximumSize}"
			nowarn="${javac.nowarn}"
			srcdir="${source.dir}"
			excludes="**/test/**"
			source="${javac.source}"
			target="${javac.target}"
		/>
	</target>

	<target name="compile_1.4">
		<mkdir dir="${classes.dir}" />
		<javac
			classpathref="project.classpath"
			bootclasspath="${javac.bootclasspath}"
			compiler="javac1.4"
			debug="${javac.debug}"
			deprecation="${javac.deprecation}"
			destdir="${classes.dir}"
			fork="${javac.fork}"
			memoryMaximumSize="${javac.memoryMaximumSize}"
			nowarn="${javac.nowarn}"
			srcdir="${source.dir}"
			source="1.4"
			target="1.4"
		/>
	</target>

	<target name="jar" depends="compile">
		<jar
			basedir="${classes.dir}"
			jarfile="${jar.file}"
		/>
		<antcall target="jar-manifest">
			<param name="jar-manifest.jar.file" value="${jar.file}"/>
		</antcall>
	</target>
	
	<target name="jar-manifest">
    	<tstamp>
	    	<format property="timestamp.isoformat" pattern="yyyy-MM-dd' 'HH:mm:ss" />
        </tstamp>
		<jar jarfile="${jar-manifest.jar.file}" update="true">
	        <manifest>
	            <attribute name="Implementation-Title" value="${product.name}"/>
	            <attribute name="Implementation-Version" value="${product.version}"/>
	            <attribute name="Built-On" value="${timestamp.isoformat}"/>
	        </manifest>
		</jar>
	</target>
	
	<target name="java2html">
		<java
			classname="com.sitescape.util.Java2Html"
			classpathref="project.classpath"
			fork="true">
				<arg value="${java2html.bat}" />
				<arg value="${source.dir}" />
				<arg value="${java2html.dir}" />
		</java>
		<move file="${java2html.dir}/stylesheet.css" tofile="${java2html.dir}/java2html.css" />
		<antcall target="javadoc" />
		<replace dir="${java2html.dir}">
			<include name="**/package-summary.html" />
			<replacefilter
				token="/\"
				value="/"
			/>
		</replace>
	</target>

	<target name="javadoc">
		<mkdir dir="${javadoc.dir}" />
		<javadoc
			additionalparam="-J-Xmx128m"
			classpathref="project.classpath"
			destdir="${javadoc.dir}"
			packagenames="com.sitescape.team.domain,
							com.sitescape.team.security.function,
							com.sitescape.team.module.binder,
							com.sitescape.team.module.folder,
							com.sitescape.team.module.profile,
							com.sitescape.team.module.workspace"
			excludepackagenames="com.sitescape.team.module.binder.impl,
				com.sitescape.team.module.folder.impl,
				com.sitescape.team.module.profile.impl,
				com.sitescape.team.module.workspace.impl"
			sourcepath="${source.dir}"
			public="true"
			stylesheetfile="${project.dir}/tools/javadoc.css"
		/>
	</target>
	
	<target name="compile-test" depends="compile">
		<mkdir dir="${test.classes.dir}"/>
		<javac
			compiler="${javac.compiler}"
			debug="${javac.debug}"
			deprecation="${javac.deprecation}"
			destdir="${test.classes.dir}"
			fork="${javac.fork}"
			memoryMaximumSize="${javac.memoryMaximumSize}"
			nowarn="${javac.nowarn}"
			srcdir="${test.source.dir}">
			<classpath location="${test.classes.dir}"/>
			<classpath refid="project.classpath"/>
		</javac>
	</target>
	
	<!-- Note: You can run an individual test by setting test.includes property
	     at the command line. For example, 
	     ant unit-test -Dtest.includes=**/CoreDaoImplTests.class
	     will only run CoreDaoImplTests and nothing else. -->
	<target name="unit-test" depends="compile-test">
		<delete dir="${test.report.dir}"/>
		<mkdir dir="${test.report.dir}"/>
		<property name="tests" value="Test*"/>

		<junit printsummary="yes" haltonfailure="yes" haltonerror="yes" fork="yes">
			<classpath location="${test.classes.dir}"/>
			<classpath location="${test.source.dir}"/>
			<classpath location="${project.dir}/web/docroot/WEB-INF/classes"/>
			<classpath refid="project.classpath"/>

			<formatter type="plain" usefile="false"/>
			<!--<formatter type="brief" usefile="false"/>-->
			<formatter type="xml"/>

			<batchtest todir="${test.report.dir}">
				<fileset dir="${test.classes.dir}" 
					includes="${test.includes}" 
					excludes="${test.excludes}"/>
			</batchtest>
		</junit>
	</target>
	
	<target name="unit-test-report">
		<mkdir dir="${test.report.dir}/html"/>
		<junitreport todir="${test.report.dir}">
			<fileset dir="${test.report.dir}">
				<include name="TEST-*.xml"/>
			</fileset>
			<report todir="${test.report.dir}/html"/>
		</junitreport>
	</target>
	
</project>