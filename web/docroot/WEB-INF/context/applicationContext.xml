<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "../dtd/spring-beans.dtd">

<beans>

	<!-- =========================== Basic Infrastructural Beans ========================== -->

	<!-- Configurer that replaces ${...} placeholders with values from ssf 
	     properties file(s) that are accessed through sPropsUtil bean. -->
	<bean id="propertyPlaceholderConfigurer" 
		class="com.sitescape.team.util.PropertyPlaceholderConfigurer" 
		depends-on="sPropsUtil">	
		<!-- As explained above, this custom configurer gets properties values
		     from SpropsUtil, NOT from the properties file specified below.
		     In other words, the following 'location' property is ignored,
		     but nevertheless present here to satisfy initialization requirement. -->
		<property name="location"><value>config/ssf.properties</value></property>								
	</bean>

	<!-- Message source for this context, loaded from localized "messages_xx" files -->
	<bean id="messageSource" class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
		<property name="basenames">
			<list>
				<value>/WEB-INF/messages/messages-ext</value>
				<value>/WEB-INF/messages/messages</value>
				<value>/WEB-INF/messages/help-messages-ext</value>
				<value>/WEB-INF/messages/help-messages</value>
			</list>
		</property>	
		<property name="defaultEncoding"><value>UTF-8</value></property>
		<!-- The factory setting for this property is -1, which indicates to cache forever.
		     Change it to a positive number (eg. 1) to enable automatic reloading, which
		     should not be used in a production environment. -->
		<!--<property name="cacheSeconds"><value>5</value></property>-->
	</bean>

	<!-- Default View Resolver -->
	<bean id="viewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
		<property name="cache"><value>true</value></property>
		<property name="viewClass"><value>org.springframework.web.servlet.view.JstlView</value></property>
		<property name="prefix"><value>/WEB-INF/jsp/</value></property>
		<property name="suffix"><value>.jsp</value></property>
	</bean>
	<!-- Enable this resolver to provide custimized views
	<bean id="customViewResolver" class="org.springframework.web.servlet.view.XmlViewResolver">
		<property name="order"><value>0</value></property>
		<property name="location"><value>/WEB-INF/views.xml</value></property>
	</bean>
	-->

	<!-- Template for expressing dependencies on all modules.
	     Do NOT ever add to this template any bean that is not a module. -->
	<bean id="dependOnAllModulesTemplate" lazy-init="true" abstract="true">
		<property name="adminModule"><ref bean="adminModule"/></property>
		<property name="binderModule"><ref bean="binderModule"/></property>
		<property name="definitionModule"><ref bean="definitionModule"/></property>
		<property name="folderModule"><ref bean="folderModule"/></property>
		<property name="ldapModule"><ref bean="ldapModule"/></property>
		<property name="profileModule"><ref bean="profileModule"/></property>
		<property name="workflowModule"><ref bean="workflowModule"/></property>
		<property name="workspaceModule"><ref bean="workspaceModule"/></property>
		<property name="fileModule"><ref bean="fileModule"/></property>	
		<property name="dashboardModule"><ref bean="dashboardModule"/></property>	
		<property name="reportModule"><ref bean="reportModule"/></property>
		<property name="icBrokerModule"><ref bean="icBrokerModule"/></property>			
		<property name="icalModule"><ref local="icalModule"/></property>
		<property name="rssModule"><ref local="rssModule"/></property>
		<property name="licenseModule"><ref local="licenseModule"/></property>
	</bean>

	<!-- Default lob handler.  Override this in applicationContext-ext.xml for specific databases -->
  	<bean id="lobHandler" class="org.springframework.jdbc.support.lob.DefaultLobHandler">
	</bean>
	
<!-- Oracle Lob handler
	<bean id="oracleExtractor" class="org.springframework.jdbc.support.nativejdbc.CommonsDbcpNativeJdbcExtractor">
	</bean>
	<bean id="lobHandler" class="org.springframework.jdbc.support.lob.OracleLobHandler">
		<property name="nativeJdbcExtractor"><ref local="oracleExtractor"/></property>
	  </bean>

 -->

	<bean id="hibernateConfiguration" class="com.sitescape.team.util.HibernateConfigurationFactory">
		<property name="sessionFactoryBean"><ref bean="&amp;sessionFactory"/></property>
	</bean>
	
	<!-- To utilize Hibernate's statistics service, hibernate.generate_statistics
	     property must be set to true in the hibernate.cfg.xml file. -->
	<bean id="hibernateStatisticsService" class="org.hibernate.jmx.StatisticsService">
		<property name="sessionFactory"><ref bean="sessionFactory"/></property>
	</bean>
	
	<bean id="springContextUtil" class="com.sitescape.team.util.SpringContextUtil" />

	<bean id="dataSource" class="com.sitescape.team.util.JndiObjectFactoryBean">
		<property name="jndiName"><value>java:comp/env/jdbc/SiteScapePool</value></property>
	</bean>
  
	<bean id="performanceMonitorInterceptor" class="org.springframework.aop.interceptor.PerformanceMonitorInterceptor">
	</bean>
	
	<bean id="scheduler" class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
		<property name="dataSource"><ref local="dataSource"/></property>
		<property name="autoStartup"><value>true</value></property>
		<property name="startupDelay"><value>30</value></property>
		<property name="schedulerName"><value>Sitescape</value></property>
		<property name="quartzProperties">
		<props>
			<prop key="org.quartz.threadPool.makeThreadsDaemons">true</prop>
			<prop key="org.quartz.jobStore.tablePrefix">SSQRTZ_</prop>
			<prop key="org.quartz.plugin.triggHistory.class">org.quartz.plugins.history.LoggingJobHistoryPlugin</prop>
			<prop key="org.quartz.jobStore.driverDelegateClass">${org.quartz.jobStore.driverDelegateClass}</prop>
			<prop key="org.quartz.jobStore.selectWithLockSQL">${org.quartz.jobStore.selectWithLockSQL}</prop>
		</props>
		</property>
		<property name="jobListeners">
			<list>
			<bean class="com.sitescape.team.jobs.CleanupJobListener"/>
			</list>
		</property>
	</bean>

	<!-- Local transaction manager. If using JTA, comment out this element -->
	<bean id="transactionManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager">
		<property name="sessionFactory"><ref bean="sessionFactory"/></property>
	</bean>

	<!-- JTA transaction manager. If using local transaction, comment out this element -->	
	<!--<bean id="transactionManager" class="com.sitescape.team.util.JtaTransactionManager" />-->

	<bean id="baseTransactionProxy" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean"
			abstract="true">
		<property name="transactionManager"><ref bean="transactionManager"/></property>
		<property name="preInterceptors">
			<list>
				<ref bean="performanceMonitorInterceptor"/>
				<ref bean="indexSynchronizationManagerInterceptor"/>
				<ref bean="userReloadInterceptor"/>
			</list>
		</property>
		<!-- Warning: When used with jta, specified isolation levels are ignored and ISOLATION_DEFAULT is used instead. -->
		<property name="transactionAttributes">
			<props>
				<prop key="add*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="delete*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="modify*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="update*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="create*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="set*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="get*">PROPAGATION_REQUIRED,readOnly,+com.sitescape.team.security.AccessControlException,+com.sitescape.team.exception.UncheckedCodedException</prop>
				<prop key="index*">PROPAGATION_REQUIRED,readOnly,+com.sitescape.team.security.AccessControlException</prop>
			</props>
		</property>
	</bean>

	<bean id="transactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
		<property name="transactionManager"><ref bean="transactionManager"/></property>
		<property name="isolationLevelName"><value>ISOLATION_READ_COMMITTED</value></property>
		<property name="propagationBehaviorName"><value>PROPAGATION_REQUIRED</value></property>
	</bean>

	<bean id="userReloadInterceptor" class="com.sitescape.team.util.aopalliance.UserReloadInterceptor">
		<property name="profileDao"><ref local="profileDao"/></property>
	</bean>
	
	<bean id="modelProcessorManager" class="com.sitescape.team.modelprocessor.ProcessorManager">
		<property name="config">
			<bean class="com.sitescape.team.util.DefaultMergeableXmlClassPathConfigFiles">
				<property name="configFiles">
					<list>
						<value>config/model-processor-mapping.xml</value>
					</list>		
				</property>
				<property name="validating"><value>true</value></property>
			</bean>
		</property>
	</bean>
	
	<bean id="nlt" class="com.sitescape.team.util.NLT"/>
	
	<bean id="definitionHelper" class="com.sitescape.team.web.util.DefinitionHelper">
		<property name="definitionModule"><ref bean="definitionModule"/> </property>
		<property name="definitionBuilderConfig"><ref local="definitionBuilderConfig"/></property>		
	</bean>
	
	<bean id="sPropsUtil" class="com.sitescape.team.util.SPropsUtil">
		<property name="config">
			<bean class="com.sitescape.team.util.PropertiesClassPathConfigFiles">
				<property name="configFiles">
					<list>
						<value>config/ssf.properties</value>
						<value>config/ssf-additional.properties</value>
						<value>optional:config/ssf-ext.properties</value>
					</list>		
				</property>
			</bean>
		</property>
	</bean>
	
	<bean id="zoneConfig" class="com.sitescape.team.util.SZoneConfig">
		<property name="configDocs">
			<bean class="com.sitescape.team.util.DefaultMergeableXmlClassPathConfigFiles">
				<property name="configFiles">
					<list>
						<value>config/zone.cfg.xml</value>
						<value>optional:config/zone-ext.cfg.xml</value>
					</list>		
				</property>
				<property name="validating"><value>false</value></property>
				<property name="styleSheet"><value>/WEB-INF/xslt/zone.cfg.xslt</value></property>
			</bean>
		</property>
	</bean>

	<!-- ========================= Portlet Common Infrastructural Beans ======================== -->
	
	<bean id="localeResolver" class="com.sitescape.team.portletadapter.support.UserLocaleResolver" />	
	
	<!-- Portlet Parameter-based Mapping Interceptor -->
	<bean id="portletParameterMappingInterceptor" class="org.springframework.web.portlet.handler.ParameterMappingInterceptor"/>

	<!-- Template for the Portlet Mode - Parameter Handler Mapping Beans -->
	<bean id="portletModeParameterHandlerMappingTemplate" class="org.springframework.web.portlet.handler.PortletModeParameterHandlerMapping" lazy-init="true" abstract="true">
        <property name="order"><value>10</value></property>
		<property name="interceptors">
			<list>
				<ref bean="portletParameterMappingInterceptor"/>
				<!-- Check user login -->
				<ref bean="portletLoginCheckInterceptor"/>
				<!-- Set up request context -->
				<ref bean="portletInitRequestContextInterceptor"/>
				<!-- Enable Open-Session-In-View pattern for Hibernate ORM.
				     This must come before userPreloadInterceptor since it
				     might need to perform DB lookup -->
				<ref bean="portletOpenSessionInViewInterceptor"/>
				<!-- Preload user object for the duration of request -->
				<ref bean="portletUserPreloadInterceptor"/>
			</list>
		</property>
	</bean>

	<!-- Template for the Portlet Mode Handler Mapping Beans -->
	<bean id="portletModeHandlerMappingTemplate" class="org.springframework.web.portlet.handler.PortletModeHandlerMapping" lazy-init="true" abstract="true">
        <property name="order"><value>20</value></property>
		<property name="interceptors">
			<list>
				<!-- Check user login -->
				<ref bean="portletLoginCheckInterceptor"/>
				<!-- Set up request context -->
				<ref bean="portletInitRequestContextInterceptor"/>
				<!-- Enable Open-Session-In-View pattern for Hibernate ORM.
				     This must come before userPreloadInterceptor since it
				     might need to perform DB lookup -->
				<ref bean="portletOpenSessionInViewInterceptor"/>
				<!-- Preload user object for the duration of each request -->
				<ref bean="portletUserPreloadInterceptor"/>
			</list>
		</property>
	</bean>

	<!-- Default Exception Handler Bean -->
    <bean id="portletDefaultExceptionHandlerTemplate" class="org.springframework.web.portlet.handler.SimpleMappingExceptionResolver" lazy-init="true" abstract="true">
		<property name="defaultErrorView"><value>common/defError</value></property>
		<property name="exceptionMappings">
			<props>
				<prop key="com.sitescape.team.exception.CheckedCodedException">common/defCodedError</prop>
				<prop key="com.sitescape.team.exception.UncheckedCodedException">common/defCodedError</prop>
				<prop key="com.sitescape.team.module.file.WriteFilesException">common/defCodedError</prop>
				<prop key="javax.portlet.PortletSecurityException">common/notAuthorized</prop>
				<prop key="javax.portlet.UnavailableException">common/notAvailable</prop>
			</props>
		</property>  
	</bean>

	<!-- Used for open-session-in-view pattern -->
	<bean id="portletOpenSessionInViewInterceptor" class="com.sitescape.team.web.portlet.handler.OpenSessionInViewInterceptor">
		<property name="sessionFactory"><ref bean="sessionFactory"/></property>
	</bean>
	
	<bean id="portletLoginCheckInterceptor" class="com.sitescape.team.web.portlet.handler.LoginCheckInterceptor"/>
		
	<bean id="portletInitRequestContextInterceptor" class="com.sitescape.team.web.portlet.handler.InitRequestContextInterceptor"/>
		
	<bean id="portletUserPreloadInterceptor" class="com.sitescape.team.web.portlet.handler.UserPreloadInterceptor" depends-on="sPropsUtil">
		<property name="profileDao"><ref local="profileDao"/></property>
		<property name="profileModule"><ref local="profileModule"/></property>
	</bean>	

	<!-- ============================ Indexing/Search Service =========================== -->
	
	<bean id="luceneSessionFactory" class = "com.sitescape.team.search.local.LocalLuceneSessionFactory" depends-on="sPropsUtil">
		<property name="indexRootDir"><value>${data.luceneindex.root.dir}/lucene</value></property>
	</bean>
		
	<bean id="indexSynchronizationManager" class="com.sitescape.team.search.IndexSynchronizationManager">
		<property name="luceneSessionFactory"><ref local="luceneSessionFactory"/></property>
	</bean>
	
	<bean id="indexSynchronizationManagerInterceptor" class="com.sitescape.team.search.interceptor.IndexSynchronizationManagerInterceptor">
	</bean>	
	
	<!-- ============================== Document Converter ============================ -->

	<bean id="converterCommon" abstract="true">
        <property name="fileModule"><ref local="fileModule"/></property>
    </bean>
	
	<!--  OpenOffice converter for 'view file as HTML' functionality
			% C:\Program Files\OpenOffice.org 2.0\program\soffice.exe "-accept=socket,port=8100;urp;"
	 -->
    <bean id="htmlOpenOfficeConverter" class="com.sitescape.team.docconverter.impl.HtmlOpenOfficeConverter" parent="converterCommon">
        <property name="host"><value>localhost</value></property>
        <property name="port"><value>8100</value></property>
    </bean>
    
    <bean id="textOpenOfficeConverter" class="com.sitescape.team.docconverter.impl.TextOpenOfficeConverter" parent="converterCommon">
		<property name="host"><value>localhost</value></property>
        <property name="port"><value>8100</value></property>
        <property name="nullTransform"><value>config/null.xslt</value></property>
        <property name="excludedExtensions"><value>jpg,jpeg,gif,tiff,png,exe,mpeg,mov</value></property>
    </bean>
    
    <bean id="imageOpenOfficeConverter" class="com.sitescape.team.docconverter.impl.ImageOpenOfficeConverter" parent="converterCommon">
        <property name="host"><value>localhost</value></property>
        <property name="port"><value>8100</value></property>
    </bean>

    <!-- ============================== RSS Generator ============================ -->
	
    <bean id="rssModule" parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.rss.impl.RssModuleImpl">
    	<property name="rssRootDir"><value>${data.root.dir}/rss</value></property>
    </bean>
	
    <!-- ============================== ical Converter ============================ -->
	
    <bean id="icalModule" class="com.sitescape.team.module.ical.impl.IcalModuleImpl">	
    	<property name="binderModule"><ref local="binderModule"/></property>
    	<property name="folderModule"><ref local="folderModule"/></property>
    </bean>
	
	<!-- ================================ Security Service =============================== -->
	
	<bean id="accessControlManager" class="com.sitescape.team.security.impl.AccessControlManagerImpl">
		<property name="functionManager"><ref local="functionManager"/></property>
		<property name="workAreaFunctionMembershipManager"><ref local="workAreaFunctionMembershipManager"/></property>
		<property name="profileDao"><ref local="profileDao"/></property>
		<property name="licenseManager"><ref bean="licenseManager"/></property>
	</bean>
	<!--<bean id="accessControlManager" class="com.sitescape.team.security.impl.NullAccessControlManager">
	</bean>
	-->
	
	<bean id="aclManager" class="com.sitescape.team.security.acl.impl.AclManagerImpl">
	</bean>

	<bean id="functionManager" class="com.sitescape.team.security.function.FunctionManagerImpl">
		<property name="securityDao"><ref local="securityDao"/></property>
	</bean>

	<bean id="workAreaFunctionMembershipManager" class="com.sitescape.team.security.function.WorkAreaFunctionMembershipManagerImpl">
		<property name="securityDao"><ref local="securityDao"/></property>		
	</bean>
	
	<bean id="securityDao" class="com.sitescape.team.security.dao.SecurityDaoImpl">
		<property name="sessionFactory"><ref bean="sessionFactory"/></property>
	</bean>
	
	<bean id="authenticationManager"  class="com.sitescape.team.security.authentication.impl.AuthenticationManagerImpl" depends-on="sPropsUtil">
			<property name="profileDao"><ref local="profileDao"/></property>						
			<property name="coreDao"><ref local="coreDao"/></property>						
			<property name="adminModule"><ref local="adminModule"/></property>						
			<property name="profileModule"><ref local="profileModule"/></property>						
			<property name="reportModule"><ref local="reportModule"/></property>						
	</bean>	
	
	<bean id="stringCheckUtil" class = "com.sitescape.team.util.stringcheck.StringCheckUtil" depends-on="sPropsUtil">
	</bean>	
	
	<!-- =========================== Business Components =========================== -->
	
	<!-- Template for expressing dependencies on common services in the system.
	     This includes DAO components and a variety of other services and managers 
	     that are commonly used by modules. 
	     
	     IMPORTANT: Do NOT ever add module components to this template, since it 
	     can cause circular dependencies among modules! Instead, inter-module
	     dependencies must be expressed directly in the bean declaration of the
	     refering module. -->
	     
	<bean id="dependOnCommonServicesTemplate" abstract="true">
		<property name="coreDao"><ref local="coreDao"/></property>
		<property name="folderDao"><ref bean="folderDao"/></property>
		<property name="profileDao"><ref local="profileDao"/></property>
		<property name="functionManager"><ref bean="functionManager"/></property>	
		<property name="accessControlManager"><ref local="accessControlManager"/></property>
		<property name="aclManager"><ref local="aclManager"/></property>
		<property name="scheduler"><ref local="scheduler"/></property>
		<property name="processorManager"><ref local="modelProcessorManager"/></property>
		<property name="luceneSessionFactory"><ref local="luceneSessionFactory"/></property>
		<property name="workAreaFunctionMembershipManager"><ref local="workAreaFunctionMembershipManager"/></property>
		<property name="resourceDriverManager"><ref bean="resourceDriverManager"/></property>
		<property name="licenseManager"><ref bean="licenseManager"/></property>
	</bean>
	
	<bean id="processorDependencyTemplate" parent="dependOnCommonServicesTemplate" abstract="true">
		<property name="transactionTemplate"><ref local="transactionTemplate"/></property>
		<property name="definitionModule"><ref local="definitionModule"/></property>
		<property name="workflowModule"><ref bean="workflowModule"/></property>
		<property name="fileModule"><ref local="fileModule"/></property>
		<property name="reportModule"><ref local="reportModule"/></property>
		<property name="rssModule"><ref local="rssModule"/></property>
	</bean>
	
	<bean id="workspaceModule" parent="baseTransactionProxy">
		<property name="target">
			<bean parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.workspace.impl.WorkspaceModuleImpl">
				<property name="definitionModule"><ref local="definitionModule"/></property>
			</bean>
		</property>
	<!-- addFolder, addWorkspace provide transaction semantics at a finer
		granularity then the method. Handled by processor through transactionTemplate-->
		<property name="transactionAttributes">
			<props>
				<prop key="get*">PROPAGATION_REQUIRED,readOnly,+com.sitescape.team.security.AccessControlException,+com.sitescape.team.exception.UncheckedCodedException</prop>
			</props>
		</property>
	</bean>

	<!--  Initialize the zone and checks dependencies -->
	<bean id="zoneModule"  parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.zone.impl.ZoneModuleImpl" depends-on="nlt, zoneConfig, binderAccessUtils" >
		<property name="transactionTemplate"><ref local="transactionTemplate"/></property>
		<property name="adminModule"><ref local="adminModule"/></property>
		<property name="definitionModule"><ref local="definitionModule"/></property>
		<property name="profileModule"><ref local="profileModule"/></property>
		<property name="binderModule"><ref local="binderModule"/></property>
		<property name="workflowModule"><ref bean="workflowModule"/></property>
	</bean>
	
	
	<bean id="adminModule" parent="baseTransactionProxy">
		<property name="target">
			<bean parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.admin.impl.AdminModuleImpl">
				<property name="mailModule"><ref local="mailModule"/></property>
				<property name="definitionModule"><ref local="definitionModule"/></property>
				<property name="folderModule"><ref local="folderModule"/></property>
				<property name="workspaceModule"><ref local="workspaceModule"/></property>
				<property name="binderModule"><ref local="binderModule"/></property>
				<property name="dashboardModule"><ref local="dashboardModule"/></property>
				<property name="fileModule"><ref local="fileModule"/></property>
				<property name="icalModule"><ref local="icalModule"/></property>
				<property name="transactionTemplate"><ref local="transactionTemplate"/></property>
			</bean>
		</property>
		<!-- addBinderFromTemplate, setWorkAreaFunctionMemberships, setWorkAreaFunctionMembershipInherited, setWorkAreaOwner provide transaction semantics at a finer
		granularity then the method. Handled by processor through transactionTemplate-->
		<property name="transactionAttributes">
			<props>
				<prop key="addDefaultTemplate">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="addTemplate">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="addTemplateFromBinder">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="addFunction">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="addPosting">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="delete*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="modify*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="update*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="setPostingSchedule">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="get*">PROPAGATION_REQUIRED,readOnly,+com.sitescape.team.security.AccessControlException,+com.sitescape.team.exception.UncheckedCodedException</prop>
			</props>
		</property>
	</bean>


	<bean id="folderModule" parent="baseTransactionProxy" depends-on="zoneConfig, scheduler" >
		<property name="target"><ref bean="folderModuleTarget"/></property>
		<!-- addEntry, addFolder, addReply,addVote, modifyEntry provide transaction semantics at a finer
		granularity then the method. Handled by processor through transactionTemplate-->
		<property name="transactionAttributes">
			<props>
				<prop key="addSubscription">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="addEntryWorkflow">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="delete*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="get*">PROPAGATION_REQUIRED,readOnly,+com.sitescape.team.security.AccessControlException,+com.sitescape.team.exception.UncheckedCodedException</prop>
				<prop key="modifyWorkflowState">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="moveEntry">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="reserveEntry">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="set*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="unreserveEntry">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
			</props>
		</property>
	</bean>

	<bean id="profileModule" parent="baseTransactionProxy">
		<property name="target">
			<bean parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.profile.impl.ProfileModuleImpl">
				<property name="definitionModule"><ref bean="definitionModule"/></property>
				<property name="adminModule"><ref local="adminModule"/></property>
				<property name="binderModule"><ref local="binderModule"/></property>
				<property name="transactionTemplate"><ref local="transactionTemplate"/></property>
			</bean>
		</property>
		<!-- addUser, addGroup, addEntries, modifyEntry, addUserFromPortal,modifyUserFromPortal, addUserWorkspace provide transaction semantics at a finer
		granularity then the method. Handled by processor through transactionTemplate-->
		<property name="transactionAttributes">
			<props>
				<prop key="deleteEntry">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="get*">PROPAGATION_REQUIRED,readOnly,+com.sitescape.team.security.AccessControlException,+com.sitescape.team.exception.UncheckedCodedException</prop>
				<prop key="set*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
			</props>
		</property>
	</bean>

	<bean id="defaultWorkspaceCoreProcessor" parent="processorDependencyTemplate" class="com.sitescape.team.module.workspace.impl.DefaultWorkspaceCoreProcessor"/>

	<bean id="defaultFolderCoreProcessor" parent="processorDependencyTemplate" class="com.sitescape.team.module.folder.impl.DefaultFolderCoreProcessor"/>

	<bean id="defaultProfileCoreProcessor" parent="processorDependencyTemplate" class="com.sitescape.team.module.profile.impl.DefaultProfileCoreProcessor"/>

	<bean id="defaultTemplateCoreProcessor" parent="processorDependencyTemplate" class="com.sitescape.team.module.binder.impl.DefaultTemplateCoreProcessor"/>
	
	<bean id="binderModule" parent="baseTransactionProxy">
		<property name="target">
			<bean parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.binder.impl.BinderModuleImpl">
				<property name="transactionTemplate"><ref local="transactionTemplate"/></property>
			</bean>
		</property>
		<!-- modifyBinder, setTeamMembers, setTeamMembershipInherited provide transaction semantics at a finer
		granularity then the method. Handled by processor through transactionTemplate-->
		<property name="transactionAttributes">
			<props>
				<prop key="add*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="delete*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="get*">PROPAGATION_REQUIRED,readOnly,+com.sitescape.team.security.AccessControlException,+com.sitescape.team.exception.UncheckedCodedException</prop>
				<prop key="index*">PROPAGATION_REQUIRED,readOnly,+com.sitescape.team.security.AccessControlException</prop>
				<prop key="modifyNotification">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="modifyPosting">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="modifyTag">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="move*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="setDefinition*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="setProperty*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="setNotification*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="setPosting*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				<prop key="setTag*">PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED</prop>
				
			</props>
		</property>
	</bean>
	<bean id="binderAccessUtils" class="com.sitescape.team.module.binder.AccessUtils">
		<property name="accessControlManager"><ref bean="accessControlManager"/> </property>
		<property name="profileDao"><ref local="profileDao"/></property>
	</bean>
	<bean id="definitionBuilderConfig" class="com.sitescape.team.module.definition.DefinitionConfigurationBuilder"
		depends-on="licenseChecker">
		<property name="configFiles">
			<list>
				<value>config/definition_builder_config.xml</value>
			</list>		
		</property>
		<!-- TODO: We must use validation! -->
		<property name="validating"><value>true</value></property>
	</bean>

	<bean id="definitionModule" parent="baseTransactionProxy" depends-on="sPropsUtil" >
		<property name="target">
			<bean parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.definition.impl.DefinitionModuleImpl">
				<property name="workflowModule"><ref bean="workflowModule"/></property>
				<property name="definitionBuilderConfig"><ref local="definitionBuilderConfig"/></property>		
			</bean>	
		</property>
	</bean>

	<bean id="dashboardModule" parent="baseTransactionProxy">
		<property name="target">
			<bean parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.dashboard.impl.DashboardModuleImpl">
				<property name="binderModule"><ref local="binderModule"/></property>
			</bean>	
		</property>
	</bean>
	<bean id="defaultFolderEmailFormatter" parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.mail.impl.DefaultFolderEmailFormatter">
		<property name="definitionModule"><ref local="definitionModule"/></property>
		<property name="folderModule"><ref local="folderModule"/></property>
		<property name="binderModule"><ref local="binderModule"/></property>
		<property name="mailModule"><ref local="mailModule"/></property>
		<property name="icalModule"><ref local="icalModule"/></property>
	</bean>
	

	<bean id="fileModule" parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.file.impl.FileModuleImpl" depends-on="sPropsUtil">
		<property name="transactionTemplate"><ref local="transactionTemplate"/></property>
		<property name="htmlConverterManager"><ref bean="htmlConverterManager"/></property>
		<property name="imageConverterManager"><ref bean="imageConverterManager"/></property>
	</bean>
	
	<bean id="reportModule"  parent="baseTransactionProxy">
		<!--  dependences prevent inheriting from dependOnCommonServicesTemplate -->
		<property name="target">
			<bean class="com.sitescape.team.module.report.impl.ReportModuleImpl" depends-on="sPropsUtil">
				<property name="coreDao"><ref bean="coreDao"/></property>
				<property name="accessControlManager"><ref local="accessControlManager"/></property>
				<property name="sessionFactory"><ref bean="sessionFactory"/></property>
				<property name="binderModule"><ref bean="binderModule"/></property>
			</bean>
		</property>
	</bean>			

	<bean id="licenseModule"  parent="baseTransactionProxy">
		<property name="target"><ref bean="licenseModuleTarget"/></property>
	</bean>			
	<bean id="licenseChecker" class="com.sitescape.team.module.license.LicenseChecker">
		<property name="licenseManager"><ref bean="licenseManager"/> </property>
	</bean>

	<bean id="dashboardHelper" class="com.sitescape.team.web.util.DashboardHelper" parent="dependOnAllModulesTemplate"/>
		
	<bean id="ssfs" class="org.springframework.aop.framework.ProxyFactoryBean" depends-on="sPropsUtil">
		<property name="target">
			<bean class="com.sitescape.team.ssfs.server.impl.SiteScapeFileSystemImpl" parent="dependOnAllModulesTemplate">
				<property name="mimeTypes"><ref local="mimeTypes"/></property>
				<property name="coreDao"><ref local="coreDao"/></property>
			</bean>
		</property>
		<property name="proxyInterfaces">
			<value>com.sitescape.team.ssfs.server.SiteScapeFileSystem</value>
		</property>
		<property name="interceptorNames">
			<list>
				<!-- Setting up of request context is done by the cross-context
				     dispatcher server/servlet. The same servlet also takes care
				     of logging. -->
				<value>aopallianceOpenSessionInViewInterceptor</value>
				<value>aopallianceUserPreloadInterceptor</value>
				<value>aopallianceMethodInvocationTraceInterceptor</value>
			</list>
		</property>
	</bean>
	
	<bean id="wsFacade" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="target">
			<bean class="com.sitescape.team.remoting.ws.FacadeImpl" parent="dependOnAllModulesTemplate" />
		</property>
		<property name="proxyInterfaces">
			<value>com.sitescape.team.remoting.Facade</value>
		</property>
		<property name="interceptorNames">
			<list>
				<value>checkEnabledInterceptor</value>
				<value>aopallianceLoggingInterceptor</value>
				<!-- When a user request is served, typically one of the very first 
				     interceptors we define is one that sets up request context for 
				     the serving thread. In the case of Web request, typically this
				     information comes from either the request object or the session
				     and the interceptor sets up thread context using the user 
				     information. However, in the case Web Service, neither request
				     object nor session is relevant. The same piece of information
				     (i.e., zone and user names) must come from the WS framework. 
				     Specifically, when used in conjunction with WS-Security compliant
				     tool such as WSS4J, the hook is provided via a callback routine
				     that the framework invokes to obtain password information for
				     the user making the request. That's where we set up our request 
				     context as well. -->
				<value>aopallianceOpenSessionInViewInterceptor</value>
				<value>aopallianceUserPreloadInterceptor</value>
				<value>loginInfoInterceptor</value>
			</list>
		</property>
	</bean>
	
	<bean id="aopallianceLoggingInterceptor" class="com.sitescape.team.util.aopalliance.LoggingInterceptor"/>
	
	<bean id="aopallianceOpenSessionInViewInterceptor" class="com.sitescape.team.util.aopalliance.OpenSessionInViewInterceptor">
		<property name="sessionFactory"><ref bean="sessionFactory"/></property>
	</bean>
	
	<bean id="aopallianceUserPreloadInterceptor" class="com.sitescape.team.util.aopalliance.UserPreloadInterceptor">
		<property name="profileDao"><ref local="profileDao"/></property>
	</bean>
	
	<bean id="aopallianceMethodInvocationTraceInterceptor" class="com.sitescape.team.util.aopalliance.MethodInvocationTraceInterceptor"/>
	
	<bean id="loginInfoInterceptor" class="com.sitescape.team.remoting.interceptor.LoginInfoInterceptor">
		<property name="reportModule"><ref local="reportModule"/></property>
	</bean>
	
	<bean id="checkEnabledInterceptor" class="com.sitescape.team.remoting.ws.interceptor.CheckEnabledInterceptor" />
	
	<!-- referenced internally when viewing files and sending mail -->
	<bean id="mimeTypes" class="org.springframework.mail.javamail.ConfigurableMimeFileTypeMap">
		<property name="mappings"><value><![CDATA[
application/vnd.oasis.opendocument.database               odb
application/vnd.oasis.opendocument.chart                  odc
application/vnd.oasis.opendocument.formula                odf
application/vnd.oasis.opendocument.graphics               odg
application/vnd.oasis.opendocument.image                  odi
application/vnd.oasis.opendocument.text-master            odm
application/vnd.oasis.opendocument.presentation           odp
application/vnd.oasis.opendocument.spreadsheet            ods
application/vnd.oasis.opendocument.text                   odt
application/vnd.oasis.opendocument.graphics-template      otg
application/vnd.oasis.opendocument.text-web               oth
application/vnd.oasis.opendocument.presentation-template  otp
application/vnd.oasis.opendocument.spreadsheet-template   ots
application/vnd.oasis.opendocument.text-template          ott
#   OpenOffice.org (version <= 1.1.4) and Sun StarOffice (version >= 6.0)
application/vnd.sun.xml.calc.template                     stc
application/vnd.sun.xml.draw.template                     std
application/vnd.sun.xml.impress.template                  sti
application/vnd.sun.xml.writer.template                   stw
application/vnd.sun.xml.calc                              sxc
application/vnd.sun.xml.draw                              sxd
application/vnd.sun.xml.writer.global                     sxg
application/vnd.sun.xml.impress                           sxi
application/vnd.sun.xml.math                              sxm
application/vnd.sun.xml.writer                            sxw
#   StarDivision and Sun StarOffice (4.0 < version <= 5.2)
application/vnd.stardivision.draw                         sda
application/vnd.stardivision.calc                         sdc
application/vnd.stardivision.impress                      sdd
application/vnd.stardivision.mail                         sdm
application/vnd.stardivision.impress.packed               sdp
application/vnd.stardivision.chart                        sds
application/vnd.stardivision.writer                       sdw vob vor
application/vnd.stardivision.writer-global                sgl
application/vnd.stardivision.math                         smf		
text/calendar											  ics
	  ]]></value></property>
	</bean>
		
	<!-- =========================Portlet support =========================================================== -->	

	<!-- ========================= Data Access (DAO) Components ====================== -->
	
	<bean id="coreDao" class="com.sitescape.team.dao.impl.CoreDaoImpl">
		<property name="sessionFactory"><ref bean="sessionFactory"/></property>
	</bean>
	<bean id="profileDao" class="com.sitescape.team.dao.impl.ProfileDaoImpl" depends-on="zoneConfig,sPropsUtil">
		<property name="sessionFactory"><ref bean="sessionFactory"/></property>
		<property name="coreDao"><ref local="coreDao"/></property>
	</bean>

	<!-- ======================== File & Repository Services ====================== -->
	
	<bean id="simpleFileRepository" class="com.sitescape.team.repository.file.FileRepositorySessionFactory" 
		depends-on="sPropsUtil" init-method="initialize" destroy-method="shutdown">
		<property name="repositoryRootDir"><value>${data.simplefilerepository.root.dir}/filerepository</value></property>
		<property name="archiveStore"><ref bean="archiveStore"/></property>
	</bean>

	<bean id="jackrabbitRepository" class="com.sitescape.team.repository.jcr.jackrabbit.JCRRepositorySessionFactory"
		init-method="initialize" destroy-method="shutdown">	
		<property name="fileTypeMap"><ref local="mimeTypes"/></property>
		<property name="repositoryRootDir"><value>${data.jackrabbitrepository.root.dir}/jackrabbit</value></property>
		<property name="homeSubdirName"><value>home</value></property>
		<property name="configFileName"><value>jackrabbit-repository.xml</value></property>
		<property name="initializeOnStartup"><value>false</value></property>
		<property name="username"><value>none</value></property>
		<property name="password"><value>none</value></property>
		<property name="versionDeletionAllowed"><value>true</value></property>
		<property name="archiveStore"><ref bean="archiveStore"/></property>
	</bean>
	
	<!-- Uncomment this to use Slide-based WebDAV server as a repository -->
	<!--<bean id="webdavRepository" class="com.sitescape.team.repository.webdav.WebdavRepositorySessionFactory"
		init-method="initialize" destroy-method="shutdown">
		<property name="hostUrl"><value>${webdav.repository.hosturl}</value></property>
		<property name="contextPath"><value>${webdav.repository.context.path}</value></property>
		<property name="docRootPath"><value>${webdav.repository.document.root.path}</value></property>
		<property name="username"><value>${webdav.repository.username}</value></property>
		<property name="password"><value>${webdav.repository.password}</value></property>
		<property name="versionDeletionAllowed"><value>false</value></property>
		<property name="archiveStore"><ref bean="archiveStore"/></property>
	</bean>-->
	
	<!-- ================================ Presence Service =============================== -->
	<bean id="presenceService" class="com.sitescape.team.presence.impl.PresenceServiceImpl">
		<property name="jabberServer"><value>${presence.service.jabber.server}</value></property>
		<property name="jabberServerPort"><value>${presence.service.jabber.server.port}</value></property>
		<property name="enabled"><value>${presence.service.enable}</value></property>
	</bean>
	
	<!-- ================================ Instant Collaboration Support==================== -->
	<bean id="icBrokerModule" parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.ic.impl.ICBrokerModuleImpl">	
		<property name="adminId"><value>${presence.broker.admin.id}</value></property>
		<property name="adminPasswd"><value>${presence.broker.admin.passwd}</value></property>
		<property name="zonUrl"><value>${presence.broker.zon.url}</value></property>
		<property name="jabberDomain"><value>${presence.broker.jabber.domain}</value></property>
		<property name="defaultCommunityId"><value>${presence.broker.default.community.id}</value></property>
		<property name="enabled"><value>${presence.service.enable}</value></property>
	</bean>
	<!-- ================================  Mail Support =============================== -->
	<!-- this bean is only used to allow setting of initial context properties -->
	<bean id="mailJndiAccessor" class="org.springframework.jndi.JndiAccessor"/>
	<bean id="mailSender" class="com.sitescape.team.module.mail.impl.JavaMailSenderImpl">
		<property name="defaultEncoding"><value>utf-8</value></property>
		<property name="defaultFileTypeMap"><ref local="mimeTypes"/></property>
	</bean>


	<bean id="mailModule" parent="dependOnCommonServicesTemplate" class="com.sitescape.team.module.mail.impl.MailModuleImpl" 
			depends-on="zoneConfig, springContextUtil">
		<property name="mailSender"><ref local="mailSender"/></property>
		<property name="jndiAccessor"><ref local="mailJndiAccessor"/></property>
		<property name="mailRootDir"><value>${data.root.dir}/mail</value></property>
		<property name="icalModule"><ref local="icalModule"/></property>
	</bean>	
	
	<!-- ================================  JMX/MBean Support =============================== -->
	<bean id="exporter" class="org.springframework.jmx.export.MBeanExporter">
	    <property name="beans">
	      <map>
	        <entry key="SiteScape:type=Indexing,name=localLuceneSessionFactory">
	          <ref local="luceneSessionFactory"/>
	        </entry>
	        <entry key="SiteScape:type=Converter,name=htmlOpenOfficeConverter">
	          <ref local="htmlOpenOfficeConverter"/>
	        </entry>
	        <entry key="SiteScape:type=Converter,name=textOpenOfficeConverter">
	          <ref local="textOpenOfficeConverter"/>
	        </entry>
	        <entry key="SiteScape:type=Converter,name=imageOpenOfficeConverter">
	          <ref local="imageOpenOfficeConverter"/>
	        </entry>
	        <entry key="SiteScape:type=Module,name=rssModule">
	          <ref local="rssModule"/>
	        </entry>
			<entry key="SiteScape:type=Repository,name=simpleFileRepository">
	          <ref local="simpleFileRepository"/>
	        </entry>
	        <entry key="SiteScape:type=Repository,name=jackrabbitRepository">
	          <ref local="jackrabbitRepository"/>
	        </entry>
	        <!--<entry key="SiteScape:type=Repository,name=webdavRepository">
	          <ref local="webdavRepository"/>
	        </entry>-->
	        <entry key="SiteScape:type=Realtime,name=presenceService">
	          <ref local="presenceService"/>
	        </entry>
	        <entry key="SiteScape:type=Module,name=icBrokerModule">
	          <ref local="icBrokerModule"/>
	        </entry>
	        <entry key="SiteScape:type=Hibernate,name=hibernateStatisticsService">
	          <ref local="hibernateStatisticsService"/>
	        </entry>
	        <entry key="SiteScape:type=Module,name=folderModule">
	          <ref bean="folderModuleTarget"/>
	        </entry>
	      </map>
	    </property>
	</bean>
	
</beans>
