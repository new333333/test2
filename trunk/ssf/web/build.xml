<?xml version="1.0"?>

<project name="web" basedir="." default="war">
	<target name="init">
		<echo message="##### WEB #####" />
		<property environment="env" />
  		<property name="project.dir" value=".." />
  		<property file="${project.dir}/app.server.${user.name}.properties" />
  		<property file="${project.dir}/app.server.properties" />
  		<property file="${project.dir}/build.${user.name}.properties" />
  		<property file="${project.dir}/build.properties" />
		<path id="project.classpath">
			<pathelement path="${classpath}" />
			<fileset dir="${project.dir}/lib" includes="*.jar" />
		</path>
		<property name="war.file" value="ssf-web.war" />
		<taskdef resource="net/sf/antcontrib/antcontrib.properties">
			<classpath>
				<pathelement location="${project.dir}/lib/ant-contrib.jar" />
			</classpath>
		</taskdef>
		<propertycopy name="app.server.dir" from="app.server.${app.server.type}.dir" />
		<propertycopy name="app.server.deploy.dir" from="app.server.${app.server.type}.deploy.dir" />
		<propertycopy name="app.server.lib.dir" from="app.server.${app.server.type}.lib.dir" />
	</target>

	<target name="clean" depends="init">
		<delete file="${war.file}" failonerror="false" />
	</target>

	<target name="war" depends="init">
		<war
			basedir="${web.dir}"
			destfile="${war.file}"
			excludes="WEB-INF/web.xml"
			webxml="${web.dir}/WEB-INF/web.xml"
		>
			<manifest>
				<attribute name="Class-Path" value="ssf-main.jar ${classpath.manifest.ss} ${classpath.manifest.3rd}" />
			</manifest>
		</war>
	</target>

	<target name="deploy" depends="init">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<equals arg1="${app.server.type}" arg2="tomcat" />
			</or>
			<then>
				<copy todir="${app.server.deploy.dir}">
					<fileset dir="${web.dir}" excludes="WEB-INF/web.xml" />
				</copy>
			</then>
			<else>
				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
						<equals arg1="${app.server.type}" arg2="jonas-jetty" />
						<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
						<equals arg1="${app.server.type}" arg2="rexip" />
						<equals arg1="${app.server.type}" arg2="weblogic" />
					</or>
					<then>
						<property name="war.deploy.file" value="ssf-web-complete.war" />
						<echo message="${war.deploy.file}" />
					</then>
					<elseif>
						<or>
							<equals arg1="${app.server.type}" arg2="oc4j" />
							<equals arg1="${app.server.type}" arg2="orion" />
						</or>
						<then>
							<property name="war.deploy.file" value="ssf-web-complete" />
						</then>
					</elseif>
				</if>

				<copy todir="${app.server.deploy.dir}/ext.ear/${war.deploy.file}">
					<fileset dir="${web.dir}" excludes="WEB-INF/web.xml" />
				</copy>

				<mkdir dir="${app.server.deploy.dir}/ext.ear/${war.deploy.file}/META-INF" />

				<manifest file="${app.server.deploy.dir}/ext.ear/${war.deploy.file}/META-INF/MANIFEST.MF">
					<attribute name="Class-Path" value="ssf-main.jar ${classpath.manifest}" />
				</manifest>

				<if>
					<equals arg1="${app.server.type}" arg2="jonas-jetty" />
					<then>
						<copy file="${app.server.deploy.dir}/ext.ear/${war.deploy.file}/WEB-INF/web-jetty.xml.JOnAS_Jetty" tofile="${app.server.deploy.dir}/ext.ear/${war.deploy.file}/WEB-INF/web-jetty.xml" overwrite="yes" />
					</then>
				</if>

				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jonas-jetty" />
						<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
					</or>
					<then>
						<replace file="${app.server.deploy.dir}/ext.ear/${war.deploy.file}/WEB-INF/web.xml">
							<replacetoken><![CDATA[<ejb-link>com_liferay_]]></replacetoken>
							<replacevalue><![CDATA[<ejb-link>ssf-main.jar#com_liferay_]]></replacevalue>
						</replace>
					</then>
				</if>
			</else>
		</if>
	</target>

	<target name="deploy-html" depends="init">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<equals arg1="${app.server.type}" arg2="tomcat" />
			</or>
			<then>
				<copy todir="${app.server.deploy.dir}/html">
					<fileset dir="${web.dir}/html" />
				</copy>
			</then>
			<else>
				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
						<equals arg1="${app.server.type}" arg2="jonas-jetty" />
						<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
						<equals arg1="${app.server.type}" arg2="rexip" />
						<equals arg1="${app.server.type}" arg2="weblogic" />
					</or>
					<then>
						<property name="war.deploy.file" value="ssf-web-complete.war" />
					</then>
					<elseif>
						<or>
							<equals arg1="${app.server.type}" arg2="oc4j" />
							<equals arg1="${app.server.type}" arg2="orion" />
						</or>
						<then>
							<property name="war.deploy.file" value="ssf-web-complete" />
						</then>
					</elseif>
				</if>

				<copy todir="${app.server.deploy.dir}/ext.ear/${war.deploy.file}/html">
					<fileset dir="${web.dir}/html" />
				</copy>

			</else>
		</if>
	</target>

	<target name="build-skin" depends="init">
		<java
			classname="com.liferay.portal.tools.SkinBuilder"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>
			<jvmarg value="-Djava.awt.headless=true" />
			<jvmarg value="-Dskin.builder.overwrite=true" />
		</java>
	</target>

	<target name="build-website" depends="init">
		<java
			classname="com.liferay.portal.tools.WebSiteBuilder"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>
			<arg line="${asp.portal-ext.properties} ${asp.orion.config}" />
		</java>
		<antcall target="build-webxml" />
	</target>

	<target name="build-webxml" depends="init">
		<java
			classname="com.liferay.portal.tools.WebXMLBuilder"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		/>
	</target>
</project>