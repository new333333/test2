<?xml version="1.0"?>

<project name="web" basedir="." default="war">
	<import file="../build-common.xml" />
	
	<property name="war.file" value="ssf-web.war" />
		
	<propertycopy name="app.server.dir" from="app.server.${portal.type}.${app.server.type}.dir" />
	<propertycopy name="app.server.ssf.dir" from="app.server.${portal.type}.${app.server.type}.ssf.dir" />
	<property name="jsp.artifacts.dir" value="${basedir}/${jspclasses.dir}/${app.server.type}" />

	<target name="clean">
		<delete dir="{jspclasses.dir}" />
		<delete file="${war.file}" failonerror="false" />
		<delete file="${web.dir}/WEB-INF/jboss-web.xml" />
		<delete file="${web.dir}/WEB-INF/web.xml" />
	</target>

	<target name="make-jboss-web.xml">
		<if>
			<equals arg1="${portal.type}" arg2="liferay" />
			<then>
				<delete file="${web.dir}/WEB-INF/jboss-web.xml" />
				<copy file="${web.dir}/WEB-INF/jboss-web.xml.tmpl" tofile="${web.dir}/WEB-INF/jboss-web.xml" />
				<replace 
					file="${web.dir}/WEB-INF/jboss-web.xml" 
					propertyFile="replace.properties">
					<replacefilter 
						token="@@SECURITY_DOMAIN@@"
						value=""/>
				</replace>
			</then>
			<elseif>
				<equals arg1="${portal.type}" arg2="jbossportal" />
				<then>
					<delete file="${web.dir}/WEB-INF/jboss-web.xml" />
					<copy file="${web.dir}/WEB-INF/jboss-web.xml.tmpl" tofile="${web.dir}/WEB-INF/jboss-web.xml" />
					<replace 
						file="${web.dir}/WEB-INF/jboss-web.xml" 
						propertyFile="replace.properties">
						<replacefilter 
							token="@@SECURITY_DOMAIN@@"
							property="jbossportal.jbosstomcat.jbossweb.security.domain"/>
					</replace>
				</then>
			</elseif>
		</if>	
	</target>
	
	<target name="make-web.xml">
		<if>
			<equals arg1="${portal.type}" arg2="liferay" />
			<then>
				<delete file="${web.dir}/WEB-INF/web.xml" />
				<copy file="${web.dir}/WEB-INF/web.xml.tmpl" tofile="${web.dir}/WEB-INF/web.xml" />
				<replace 
					file="${web.dir}/WEB-INF/web.xml" 
					propertyFile="replace.properties">
					<replacefilter 
						token="@@SECURITY@@"
						value=""/>
					<replacefilter 
						token="@@LOGIN_FILTER@@"
						property="jbossportal.jbosstomcat.web.loginfilter"/>
					<replacefilter 
						token="@@TAGLIB_PORTLET@@"
						value=""/>
				</replace>
			</then>
			<elseif>
				<equals arg1="${portal.type}" arg2="jbossportal" />
				<then>
					<delete file="${web.dir}/WEB-INF/web.xml" />
					<copy file="${web.dir}/WEB-INF/web.xml.tmpl" tofile="${web.dir}/WEB-INF/web.xml" />
					<replace 
						file="${web.dir}/WEB-INF/web.xml" 
						propertyFile="replace.properties">
						<replacefilter 
							token="@@SECURITY@@"
							property="jbossportal.jbosstomcat.web.security"/>
						<replacefilter 
							token="@@LOGIN_FILTER@@"
							value=""/>
						<replacefilter 
							token="@@TAGLIB_PORTLET@@"
							property="jbossportal.jbosstomcat.web.taglib.portlet"/>
					</replace>
				</then>
			</elseif>
		</if>	
	</target>
		
	<target name="war" depends="make-jboss-web.xml,make-web.xml">
		<war
			basedir="${web.dir}"
			destfile="${war.file}"
			excludes="WEB-INF/web.xml,WEB-INF/web.xml.tmpl,WEB-INF/jboss-web.xml.tmpl"
			webxml="${web.dir}/WEB-INF/web.xml"
		>
			<!-- No longer necessary
			<manifest>
				<attribute name="Class-Path" value="ssf-main.jar ${classpath.manifest.ss} ${classpath.manifest.3rd}" />
			</manifest>-->
		</war>
	</target>

	<target name="deploy">
		<copy todir="${app.server.ssf.dir}">
			<fileset dir="${web.dir}">
				<exclude name="WEB-INF/*.tmpl" />
			</fileset>
		</copy>
	</target>
	
	<target name="precompile-jsp">
		<if>
			<equals arg1="${app.server.type}" arg2="tomcat" />
			<then>
				<antcall target="precompile-jsp-tomcat" />
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				<then>
					<antcall target="precompile-jsp-jboss-tomcat" />
				</then>
			</elseif>
		</if>
	</target>
	
	<!-- We are not using this target that defines a task for JspC compiler
		 (as opposed to executing the underlying class directly). For whatever 
		 reason, this runs twice as slow as the other comparable approach. -->
	<!--
	<target name="jspc" depends="init">
		<property name="jsp.artifacts.dir" value="${basedir}/${jspclasses.dir}/${app.server.type}" />
		
		<delete dir="${jsp.artifacts.dir}" />

		<path id="jspc.classpath">        
			<pathelement location="${env.JAVA_HOME}/jre/lib/rt.jar" />
			<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
			<pathelement location="${app.server.dir}/common/lib/commons-el.jar" />
			<pathelement location="${app.server.dir}/common/lib/jasper-compiler.jar" />
			<pathelement location="${app.server.dir}/common/lib/jasper-runtime.jar" />
	        <fileset dir="${app.server.dir}/common/lib">
	            <include name="**/*.jar"/>
	        </fileset>
	        <fileset dir="${app.server.dir}/common/endorsed">
	            <include name="**/*.jar"/>
	        </fileset>        
	    </path>
		
		<taskdef classname="org.apache.jasper.JspC" name="jasper2" > 
			<classpath refid="jspc.classpath"/>
		</taskdef> 

		<jasper2 
			validateXml="false" 
		    uriroot="${app.server.ssf.dir}"
		    outputDir="${jsp.artifacts.dir}"
			verbose="9"
		/> 	
	</target>
	-->
	
	<target name="precompile-jsp-init-tomcat">
		<path id="jspc.classpath">        
			<pathelement location="${env.JAVA_HOME}/jre/lib/rt.jar" />
			<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
			<pathelement location="${app.server.dir}/common/lib/commons-el.jar" />
			<pathelement location="${app.server.dir}/common/lib/jasper-compiler.jar" />
			<pathelement location="${app.server.dir}/common/lib/jasper-runtime.jar" />
	        <fileset dir="${app.server.dir}/common/lib">
	            <include name="**/*.jar"/>
	        </fileset>
	        <fileset dir="${app.server.dir}/common/endorsed">
	            <include name="**/*.jar"/>
	        </fileset>        
	    </path>		
	</target>
	
	<target name="jsp-to-java-tomcat" depends="precompile-jsp-init-tomcat">
		<java 	classname="org.apache.jasper.JspC"
				fork="true"
				newenvironment="true"
		>
			<classpath refid="jspc.classpath" />
			<arg line="-d ${jsp.artifacts.dir} -webapp ${app.server.ssf.dir}" />
		</java>	 
	</target>
	
	<target name="remove-dependent-java-tomcat" depends="precompile-jsp-init-tomcat">
		<delete>
			<fileset dir="${jsp.artifacts.dir}">
		    	<include name="**/calendar_005fview_005fday_jsp.java"/>
		    	<include name="**/calendar_005fview_005fmonth_jsp.java"/>
			    <include name="**/calendar_005fview_005fweek_jsp.java"/>
		    	<include name="**/calendar_005fnav_005fbar_jsp.java"/>
		    	<include name="**/calendar_005fview_jsp.java"/>
		    	<include name="**/collection_005fview_jsp.java"/>
		    	<include name="**/file_005flibrary_jsp.java"/>
		    	<include name="**/folder_005flist_005ffolders_jsp.java"/>
		    	<include name="**/folder_005fview_jsp.java"/>
		    	<include name="**/view_005fprofile_005fdata_005felement_jsp.java"/>
		    	<include name="**/view_005fiframe_jsp.java"/>
		    	<include name="**/view_005fpopup_jsp.java"/>
		    	<include name="**/view_005fvertical_jsp.java"/>
		    	<include name="**/view_005fhorizontal_jsp.java"/>
		    	<include name="**/view_005fforum_005fuser_005ffilters_jsp*.java"/>
		    	<include name="**/view_005fforum_005fhistory_005fbar_jsp*.java"/>
		    	<include name="**/view_005fentry_jsp.java"/>
		    	<include name="**/view_005feventtester_jsp*.java"/>
		    	<include name="**/view_005ftimepicker_jsp.java"/>
				<include name="**/view_005fentry_005fdata_005fuser_005flist_jsp.java"/>
				<include name="**/view_005fentry_005fdata_005flist_jsp.java"/>
		    	<include name="**/view_005fentry_005fdata_005ftitle_*.java"/>
			</fileset>
		</delete>
	</target>
	
	<target name="java-to-class-tomcat" depends="precompile-jsp-init-tomcat">
	    <javac srcdir="${jsp.artifacts.dir}"
	           destdir="${jsp.artifacts.dir}"
	           debug="true"
	           optimize="false"
	           source="1.5">
	            <classpath>
	                <path refid="jspc.classpath"/>
	    	        <fileset dir="${app.server.ssf.dir}/WEB-INF/lib">
	    	            <include name="**/*.jar"/>
	    	        </fileset>
	    	        <fileset dir="${app.server.dir}/common/lib/ext">
	    	            <include name="**/*.jar"/>
	    	        </fileset>
	            </classpath>           
	    </javac>  		
	</target>
	
	<target name="copy-artifacts-to-tomcat" depends="precompile-jsp-init-tomcat">
		<delete dir="${app.server.dir}/work/Catalina/localhost/ssf" />
		
		<mkdir dir="${app.server.dir}/work/Catalina/localhost/ssf" />
		
		<copy todir="${app.server.dir}/work/Catalina/localhost/ssf">
			<fileset dir="${jsp.artifacts.dir}">
				<exclude name="**/*.jspc_error" />
			</fileset>
		</copy>
		
	</target>
	
	<target name="precompile-jsp-tomcat" depends="precompile-jsp-init-tomcat">
		<delete dir="${jsp.artifacts.dir}" />

		<antcall target="jsp-to-java-tomcat" />
		
		<antcall target="remove-dependent-java-tomcat" />
		
		<antcall target="java-to-class-tomcat" />
		
		<antcall target="copy-artifacts-to-tomcat" />
	</target>
	
</project>