<?xml version="1.0"?>

<project name="web" basedir="." default="war">
	<target name="init">
		<echo message="##### WEB #####" />
		<property environment="env" />
  		<property name="project.dir" value=".." />
  		<property file="${project.dir}/app.server.${user.name}.properties" />
  		<property file="${project.dir}/app.server.properties" />
  		<property file="${project.dir}/build.${user.name}.properties" />
  		<property file="${project.dir}/build.properties" />
		<path id="project.classpath">
			<pathelement path="${classpath}" />
			<fileset dir="${project.dir}/lib" includes="*.jar" />
		</path>
		<property name="war.file" value="ssf-web.war" />
		<taskdef resource="net/sf/antcontrib/antcontrib.properties">
			<classpath>
				<pathelement location="${project.dir}/lib/ant-contrib.jar" />
			</classpath>
		</taskdef>
		<propertycopy name="app.server.dir" from="app.server.${app.server.type}.dir" />
		<propertycopy name="app.server.lib.dir" from="app.server.${app.server.type}.lib.dir" />
		<propertycopy name="app.server.deploy.dir" from="app.server.${app.server.type}.deploy.dir" />
		<propertycopy name="app.server.ssf.dir" from="app.server.${app.server.type}.ssf.dir" />
	</target>

	<target name="clean" depends="init">
		<delete dir="{jspclasses.dir}" />
		<delete file="${war.file}" failonerror="false" />
	</target>

	<target name="war" depends="init">
		<war
			basedir="${web.dir}"
			destfile="${war.file}"
			excludes="WEB-INF/web.xml"
			webxml="${web.dir}/WEB-INF/web.xml"
		>
			<manifest>
				<attribute name="Class-Path" value="ssf-main.jar ${classpath.manifest.ss} ${classpath.manifest.3rd}" />
			</manifest>
		</war>
	</target>

	<target name="deploy" depends="init">
		<copy todir="${app.server.ssf.dir}">
			<fileset dir="${web.dir}" />
		</copy>
	</target>
	
	<target name="compile-deployed-jsp" depends="init">
		<if>
			<equals arg1="${app.server.type}" arg2="tomcat" />
			<then>
				<antcall target="compile-deployed-jsp-tomcat" />
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				<then>
					<antcall target="compile-deployed-jsp-jboss-tomcat" />
				</then>
			</elseif>
		</if>
	</target>
	
	<target name="compile-deployed-jsp-tomcat" depends="init">
		<property name="jspc.classes.dir" value="${basedir}/${jspclasses.dir}/${app.server.type}" />
		
		<delete dir="${jspc.classes.dir}" />

		<path id="jspc.classpath">        
			<pathelement location="${env.JAVA_HOME}/jre/lib/rt.jar" />
			<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
			<pathelement location="${app.server.dir}/common/lib/commons-el.jar" />
			<pathelement location="${app.server.dir}/common/lib/jasper-compiler.jar" />
			<pathelement location="${app.server.dir}/common/lib/jasper-runtime.jar" />
	        <fileset dir="${app.server.dir}/common/lib">
	            <include name="**/*.jar"/>
	        </fileset>
	        <fileset dir="${app.server.dir}/common/endorsed">
	            <include name="**/*.jar"/>
	        </fileset>        
	    </path>
	 
		<java 	classname="org.apache.jasper.JspC"
				fork="true"
				newenvironment="true"
		>
			<classpath refid="jspc.classpath" />
			<arg line="-d ${jspc.classes.dir} -webapp ${app.server.ssf.dir}" />
		</java>
	 
		<delete>
			<fileset dir="${jspc.classes.dir}">
		    	<include name="**/calendar_005fnav_*.java"/>
		    	<include name="**/calendar_005fview_*.java"/>
		    	<include name="**/collection_005fview_*.java"/>
		    	<include name="**/file_005flibrary_*.java"/>
		    	<include name="**/folder_005flist_*.java"/>
		    	<include name="**/view_005fprofile_*.java"/>
		    	<include name="**/view_005fprofile_*.java"/>
		    	<include name="**/view_005fiframe_*.java"/>
		    	<include name="**/view_005fpopup_*.java"/>
		    	<include name="**/view_005fvertical_*.java"/>
		    	<include name="**/view_005fhorizontal_*.java"/>
		    	<include name="**/view_005fforum_*.java"/>
		    	<include name="**/view_005feventtester_*.java"/>
		    	<include name="**/view_005ftimepicker_*.java"/>
		    	<include name="**/view_005fentry_005fdata_005ftitle_*.java"/>
			</fileset>
		</delete>
		
	    <javac srcdir="${jspc.classes.dir}"
	           destdir="${jspc.classes.dir}"
	           debug="true"
	           optimize="false"
	           source="1.4">
	            <classpath>
	                <path refid="jspc.classpath"/>
	    	        <fileset dir="${app.server.ssf.dir}/WEB-INF/lib">
	    	            <include name="**/*.jar"/>
	    	        </fileset>
	    	        <fileset dir="${app.server.dir}/common/lib/ext">
	    	            <include name="**/*.jar"/>
	    	        </fileset>
	            </classpath>           
	    </javac>  
		
		<delete dir="${app.server.dir}/work/Catalina/localhost/ssf" />
		
		<mkdir dir="${app.server.dir}/work/Catalina/localhost/ssf" />
		
		<copy todir="${app.server.dir}/work/Catalina/localhost/ssf">
			<fileset dir="${jspc.classes.dir}">
				<exclude name="**/*.jspc_error" />
				<exclude name="**/*.java" />
			</fileset>
		</copy>
		
	</target>
	
</project>