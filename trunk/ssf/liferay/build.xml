<?xml version="1.0"?>

<project name="liferay" basedir="." default="compile">
	<import file="../build-common.xml" />
	
	<import file="../deploy-support.xml" />
	
	<property name="jar.file" value="ssf-liferay.jar" />

	<target name="clean">
		<delete dir="temp" />
	</target>
	
	<!-- Incremental deploy for ssf-liferay.jar -->
	<target name="deploy" depends="jar">
		<antcall target="deploy-jar-into-portal">
			<param name="deploy-support.jar.file" value="${jar.file}" />
		</antcall>
	</target>

	<target name="clean-app-server">
		<delete>
			<fileset dir="${app.server.lib.dir}" includes="ssf-*.jar" />
		</delete>		
		
		<delete dir="${app.server.ssf.dir}"/>
		<delete dir="${app.server.ssfs.dir}"/>
	</target>
	
	<target name="init-liferay">
		<if>
			<equals arg1="${app.server.type}" arg2="tomcat" />
			<then>
				<path id="deploy.liferay.classpath">
					<pathelement location="${env.ANT_HOME}/lib/ant.jar" />
					<!--<fileset dir="../lib" includes="*.jar" />-->
					<fileset dir="${app.server.dir}/common/endorsed" includes="*.jar" />
					<fileset dir="${app.server.lib.dir}" includes="*.jar" />
					<fileset dir="${app.server.dir}/common/lib/ext" includes="*.jar" />
					<pathelement location="${app.server.dir}/common/lib/servlet-api.jar" />
				</path>
				<property name="deploy.liferay.webinf" value="${app.server.dir}/webapps/ROOT/WEB-INF" />
				<property name="deploy.liferay.lib.dir" value="${app.server.lib.dir}" />
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				<then>
					<path id="deploy.liferay.classpath">
						<pathelement location="${app.server.deploy.dir}/liferay-portal.ear/portal-ejb.jar" />
						<pathelement location="${env.ANT_HOME}/lib/ant.jar" />
						<fileset dir="${app.server.deploy.dir}/liferay-portal.ear/lib" />
						<fileset dir="${app.server.server.dir}/lib"/>
						<!--<pathelement location="${app.server.deploy.dir}/../lib/javax.servlet.jar" />-->
						<pathelement location="${app.server.server.dir}/lib/ext/portal-kernel.jar" />
						<pathelement location="${app.server.server.dir}/lib/ext/portlet.jar" />
					</path>
					<property name="deploy.liferay.webinf" value="${app.server.deploy.dir}/liferay-portal.ear/portal-web.war/WEB-INF" />
					<property name="deploy.liferay.lib.dir" value="${app.server.deploy.dir}/liferay-portal.ear/lib" />
				</then>
			</elseif>
		</if>	
		<property name="deploy.liferay.portlet.tld" value="${deploy.liferay.webinf}/tld/liferay-portlet.tld" />
		<property name="deploy.liferay.taglib.jar" value="${deploy.liferay.webinf}/lib/util-taglib.jar" />
		<property name="deploy.liferay.util.jar" value="${deploy.liferay.lib.dir}/util-java.jar" />
		<property name="deploy.liferay.bridges.jar" value="${deploy.liferay.lib.dir}/util-bridges.jar" />
	</target>
	
	<target name="full-deploy">
		<if>
			<equals arg1="${app.server.type}" arg2="tomcat" />
			<then>
				<antcall target="deploy-liferay-tomcat" />
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				<then>
					<antcall target="deploy-liferay-jboss-tomcat" />
				</then>
			</elseif>
		</if>
	</target>
	
	<!-- Deploy additional components that are not part of ssf web app -->
	<target name="deploy-additional-components">
		<!-- portal-module component is deployed directly into Liferay web app -->
		<ant dir="${project.dir}/portal-module" target="deploy" inheritAll="false" />
		<!-- liferay component is deployed directly into Liferay web app -->
		<ant dir="${project.dir}/liferay" target="deploy" inheritAll="false" />
		<!-- ssfs component is deployed into its own web app -->
		<ant dir="${project.dir}/ssfs" target="deploy" inheritAll="false" />
	</target>
	<target name="deploy-jdbc-properties">
		<property file="${project.dir}/tools/sql/database.${user.name}.properties" />
		<property file="${project.dir}/tools/sql/database.properties" />
		<property file="${project.dir}/tools/sql/jdbc-${database.type}.properties"/>
		<replace file="${deploy.root.file}"
			token="@@@driverClassName" value="${jdbc.driver.liferay}"/>
		<replace file="${deploy.root.file}" 
			token="@@@url" value="${jdbc.url.liferay}"/>
		<replace file="${deploy.root.file}"
			token="@@@username" value="${jdbc.username.liferay}"/>
		<replace file="${deploy.root.file}"
			token="@@@password" value="${jdbc.password.liferay}"/>		
	</target>

	<target name="deploy-liferay-tomcat" depends="clean, init-liferay, clean-app-server">
		<copy file="${project.dir}/war/ssf.war" todir="temp" />		
		
		<java
			classname="com.liferay.portal.tools.PortletDeployer"
			classpathref="deploy.liferay.classpath"
			fork="true"
			newenvironment="true">

				<!-- Required Arguments -->

				<jvmarg value="-Ddeployer.base.dir=temp/" />
				<jvmarg value="-Ddeployer.dest.dir=${app.server.deploy.dir}" />
				<jvmarg value="-Ddeployer.app.server.type=${app.server.type}" />
				<jvmarg value="-Ddeployer.portlet.taglib.dtd=${deploy.liferay.portlet.tld}" />
				<jvmarg value="-Ddeployer.unpack.war=true" />

				<!-- Optional Arguments -->

				<!--<jvmarg value="-Ddeployer.jboss.prefix=1" />-->
				<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.dir}/common/lib/ext" />

				<!-- Dependent Libraries -->

				<arg value="${deploy.liferay.taglib.jar}" />
				<arg value="${deploy.liferay.util.jar}" />
				<arg value="${deploy.liferay.bridges.jar}" />
				<!--<arg value="${app.server.deploy.dir}/liferay-portal.ear/lib/util-jsf.jar" />-->
		</java>
		
		<delete dir="temp" />

		<antcall target="deploy-additional-components" />
		
		<copy todir="${app.server.dir}" overwrite="true">
			<fileset dir="resources/tomcat" />
		</copy>
		<!-- this fixes up one of the files copied above -->
		<antcall target="deploy-jdbc-properties">
			<param name="deploy.root.file" value="${app.server.dir}/conf/Catalina/localhost/ROOT.xml"/>
		</antcall>

		<ant dir="${project.dir}/tomcat" target="deploy" />

		<copy file="resources/tomcat.portal.properties" tofile="temp/portal.properties" overwrite="true" />
		<jar destfile="${deploy.liferay.lib.dir}/portal-ejb.jar" basedir="temp" 
			includes="portal.properties" update="true" />
		
		<!-- Copy jdom.jar file into our lib directory because jakarta Slide 
		     requires jdom 1.0 while the version of the Liferay we deploy
		     onto contains earlier version (beta 8?) of jdom. We should remove
		     this line once we upgarde to a later version of Liferay that contains
		     v1.0 of jdom. -->
		<!-- No longer necessary, since Liferay 4.0 changed deployment archivecture
		     completely, and we no longer share archives with them. -->
		<!--<copy file="${project.dir}/lib/jdom.jar" todir="${app.server.ssf.dir}/WEB-INF/lib" />-->
		<copy file="${project.dir}/lib/xalan.jar" todir="${app.server.dir}/common/endorsed" />
		<copy file="${project.dir}/lib/xercesImpl.jar" todir="${app.server.dir}/common/endorsed" />
		<delete file="${app.server.ssf.dir}/WEB-INF/lib/xercesImpl.jar" />
		<copy file="${project.dir}/lib/jtds.jar" todir="${app.server.dir}/common/lib" />
		
		<copy file="resources/Language-ext.properties" todir="${app.server.dir}/webapps/ROOT/WEB-INF/classes/content" />
	</target>
		
	<target name="deploy-liferay-jboss-tomcat" depends="clean, init-liferay, clean-app-server">	
		<copy file="${project.dir}/war/ssf.war" todir="temp" />		
		
		<java
			classname="com.liferay.portal.tools.PortletDeployer"
			classpathref="deploy.liferay.classpath"
			fork="true"
			newenvironment="true">

				<!-- Required Arguments -->

				<jvmarg value="-Ddeployer.base.dir=temp/" />
				<jvmarg value="-Ddeployer.dest.dir=${app.server.deploy.dir}" />
				<jvmarg value="-Ddeployer.app.server.type=${app.server.type}" />
				<jvmarg value="-Ddeployer.portlet.taglib.dtd=${deploy.liferay.portlet.tld}" />

				<!-- Optional Arguments -->

				<!-- As of Liferay 4.1.2, the following argument has no effect -->
				<!--<jvmarg value="-Ddeployer.jboss.prefix=1" />-->

				<!-- Dependent Libraries -->

				<arg value="${deploy.liferay.taglib.jar}" />
				<arg value="${deploy.liferay.util.jar}" />
				<arg value="${deploy.liferay.bridges.jar}" />
				<!--<arg value="${app.server.deploy.dir}/liferay-portal.ear/lib/util-jsf.jar" />-->
		</java>
		
		<delete dir="temp" />
		
		<antcall target="deploy-additional-components" />
		
		<copy todir="${app.server.dir}" overwrite="true">
			<fileset dir="resources/jboss-tomcat" />
		</copy>
		
		<!--<echo file="${app.server.deploy.dir}/liferay-portal.ear/portal-web.war/META-INF/MANIFEST.MF" append="true" message=" lib/ssf-liferay.jar lib/ssf-portalmodule.jar" />-->
	
		<!-- The following resource directory no longer exists. I moved them
		     under Liferay directory because we cannot guarantee that those
		     files will be exactly identical between the Liferay-JBoss and
		     the JBoss-JBoss.
		<copy todir="${app.server.dir}" overwrite="true">
			<fileset dir="${project.dir}/jboss/resources" />
		</copy>
		-->
				
		<copy file="${project.dir}/lib/jtds.jar" todir="${app.server.server.dir}/lib" />
		
		<!-- 1. JBoss 4.0.2+ classloader does not work properly if the application 
		     comes with its own log4j archive. (You get the following error -
		     log4j:ERROR A "org.jboss.logging.util.OnlyOnceErrorHandler" object is not assignable to a "org.apache.log4j.spi.ErrorHandler" variable.)
		     So, we should remove the jar file from our lib area so that it uses
		     the one that JBoss has. 
		     2. Liferay puts portlet.jar in the server's shared area (server/default/deploy/lib/ext).
		     If we have our own portlet.jar in our lib directory, the Liferay fails to 
		     register our portlets at startup time (it fails with usual ugly classloader
		     problem). So we remove that too. -->
		<delete>
			<fileset dir="${app.server.ssf.dir}/WEB-INF/lib" includes="log4j*.jar,portlet.jar"/>
		</delete>		
		
		<copy file="resources/Language-ext.properties" todir="${app.server.deploy.dir}/liferay-portal.ear/ext-ejb.jar/content" />
	</target>		
	
</project>