<?xml version="1.0"?>

<project name="main" basedir="." default="compile">
	<import file="../deploy-support.xml" />
	<target name="init">
		<echo message="##### MAIN #####" />
		<property environment="env" />
  		<property name="project.dir" value=".." />
  		<property file="${project.dir}/app.server.${user.name}.properties" />
  		<property file="${project.dir}/app.server.properties" />
  		<property file="${project.dir}/build.${user.name}.properties" />
  		<property file="${project.dir}/build.properties" />
  		<property file="${project.dir}/release.${user.name}.properties" />
  		<property file="${project.dir}/release.properties" />
		<path id="project.classpath">
			<pathelement path="${classpath}" />
			<fileset dir="${project.dir}/lib" includes="*.jar" />
		</path>
		<taskdef classpathref="project.classpath" resource="axis-tasks.properties" />
		<property name="jar.file" value="ssf-main.jar" />
		<property name="java2html.dir" value="${api.dir}/main" />
		<property name="javadoc.dir" value="${api.dir}/main" />
  		<property name="hibernate.dir" value="${basedir}/hibernate" />
		<taskdef resource="net/sf/antcontrib/antcontrib.properties">
			<classpath>
				<pathelement location="${project.dir}/lib/ant-contrib.jar" />
			</classpath>
		</taskdef>
	</target>

	<target name="clean" depends="init,ss-hib-clean">
		<delete file="${jar.file}" failonerror="false" />
		<delete dir="${java2html.dir}" />
		<delete dir="${javadoc.dir}" />
		<delete includeEmptyDirs="true" failonerror="false">
			<fileset dir="${classes.dir}" excludes="${classes.dir.excludes}" />
		</delete>
	</target>

	<target name="compile" depends="compile-common">
		<mkdir dir="${classes.dir}" />
		<javac
			classpathref="project.classpath"
			compiler="${javac.compiler}"
			debug="${javac.debug}"
			deprecation="${javac.deprecation}"
			destdir="${classes.dir}"
			fork="${javac.fork}"
			memoryMaximumSize="${javac.memoryMaximumSize}"
			nowarn="${javac.nowarn}"
			srcdir="${source.dir}"
		/>
	</target>

	<target name="compile-common" depends="init">
		<mkdir dir="${classes.dir}" />
		<javac
			classpathref="project.classpath"
			compiler="${javac.compiler}"
			debug="${javac.debug}"
			deprecation="${javac.deprecation}"
			destdir="${classes.dir}"
			includes="**/portal/PortalException.java,**/portal/SystemException.java,**/portal/util/HibernateUtil.java,**/portal/util/Lucene*.java"
			fork="${javac.fork}"
			memoryMaximumSize="${javac.memoryMaximumSize}"
			nowarn="${javac.nowarn}"
			srcdir="${source.dir}"
		/>
	</target>

	<target name="jar" depends="compile,ss-hib-gen">
		<jar
			basedir="${classes.dir}"
			jarfile="${jar.file}"
		>
			<manifest>
				<attribute name="Class-Path" value="${classpath.manifest.ss} ${classpath.manifest.3rd}" />
			</manifest>
		</jar>
	</target>

	<target name="jar-skip-hibernate" depends="compile">
		<jar
			basedir="${classes.dir}"
			jarfile="${jar.file}"
		>
			<manifest>
				<attribute name="Class-Path" value="${classpath.manifest.ss} ${classpath.manifest.3rd}" />
			</manifest>
		</jar>
	</target>

	<target name="java2html" depends="init">
		<java
			classname="com.sitescape.util.Java2Html"
			classpathref="project.classpath"
			fork="true">
				<arg value="${java2html.bat}" />
				<arg value="${source.dir}" />
				<arg value="${java2html.dir}" />
		</java>
		<move file="${java2html.dir}/stylesheet.css" tofile="${java2html.dir}/java2html.css" />
		<antcall target="javadoc" />
		<replace dir="${java2html.dir}">
			<include name="**/package-summary.html" />
			<replacefilter
				token="/\"
				value="/"
			/>
		</replace>
	</target>

	<target name="javadoc" depends="init">
		<mkdir dir="${javadoc.dir}" />
		<javadoc
			additionalparam="-J-Xmx128m"
			classpathref="project.classpath"
			destdir="${javadoc.dir}"
			packagenames="*.*"
			sourcepath="${source.dir}"
			stylesheetfile="${project.dir}/tools/javadoc.css"
		/>
	</target>

	<target name="deploy" depends="jar">
		<antcall target="deploy-jar">
			<param name="deploy-support.jar.file" value="${jar.file}" />
		</antcall>
	</target>

	<target name="deploy-skip-hibernate" depends="jar-skip-hibernate">
		<antcall target="deploy-jar">
			<param name="deploy-support.jar.file" value="${jar.file}" />
		</antcall>
	</target>

	<target name="ss-hib-clean" depends="init" description="Delete Hibernate mapping files">
		<delete failonerror="false">
			<fileset dir="${classes.dir}" includes="**/*.hbm.xml"/>
		</delete>		
	</target>

	<target name="ss-hib-gen" depends="init"
        description="Generate Hibernate mapping files from XDoclet in source">
        			
		<echo message="Building Hibernate mappings..."/>
		
	    <copy todir="${classes.dir}">
	        <fileset dir="${hibernate.dir}">
	        	<include name="**/*.hbm.xml"/>
			</fileset>
	    </copy>		
<!--		<taskdef name="xdoclet2"
		    classname="org.xdoclet.ant.XDocletTask">
			<classpath>
				<fileset dir="${project.dir}/lib" includes="*.jar" />
			</classpath>
		</taskdef>
		
	    <xdoclet2>
	    	
	        <fileset dir="${source.dir}">
	            <include name="com/sitescape/ef/**/domain/*.java"/>
	            <include name="com/sitescape/ef/security/**/*.java"/>
	        </fileset>
	    		    
	    	<component 
	    		classname="org.xdoclet.plugin.hibernate.HibernateMappingPlugin"
		    	destdir="main/${classes.dir}"
	    	    version="3.0"
	    		validate="false"
		        force="false"
	    	/>
	    </xdoclet2>	
-->
	</target>	

	  <target name="ss-create-tables" depends="init" description="Creates database tables for sitescape domain">
			<property name="schemaexport.text.value" value="false" />
	  		<antcall target="ss-create-tables-internal" />
	  </target>
	
	  <target name="ss-create-tables-script-only" depends="init" description="Creates datbase creation script for sitescape domain">
		<property name="schemaexport.text.value" value="true" />
  		<antcall target="ss-create-tables-internal" />
	  </target>
	
	  <target name="ss-create-tables-internal" depends="init">
			<path id="initpath">
	  			<pathelement location="${classes.dir}"/>
				<fileset dir="${project.dir}/util" includes="*.jar"/>
				<fileset dir="${project.dir}/lib" includes="*.jar" />
			</path>
	        <taskdef classname="org.hibernate.tool.hbm2ddl.SchemaExportTask"
		             classpathref="initpath" name="schemaexport">
	 		</taskdef> 

		    <schemaexport delimiter=";" drop="false" output="${hibernate.dir}/ss-create-tables.sql"
		    	properties="${hibernate.dir}/ss-create-tables-hibernate.properties" 
		          	quiet="false" text="${schemaexport.text.value}">
		    	<fileset dir="${classes.dir}" >
		    		<include name="com/sitescape/ef/**/*hbm.xml"/>
		            <include name="com/sitescape/ef/security/**/*hbm.xml"/>
		        </fileset>
		     </schemaexport>
	    </target>
	
	  <target name="ss-create-tables-jbpm-internal" depends="init">
			<path id="initpath">
	  			<pathelement location="${classes.dir}"/>
				<fileset dir="${project.dir}/util" includes="*.jar"/>
				<fileset dir="${project.dir}/lib" includes="*.jar" />
			</path>
	        <taskdef classname="org.hibernate.tool.hbm2ddl.SchemaExportTask"
		             classpathref="initpath" name="schemaexport">
	 		</taskdef> 

		    <schemaexport delimiter=";" drop="false" output="${hibernate.dir}/ss-create-jbpm-tables.sql"
		    	properties="${hibernate.dir}/ss-create-tables-hibernate.properties" 
		          	quiet="false" text="${schemaexport.text.value}">
				<fileset dir="${project.dir}/lib" includes="jbpm.jar" >
		    		<include name="org/jbpm/**/*hbm.xml"/>
		        </fileset>
				<fileset dir="${project.dir}/lib" includes="jbpm-identity.jar" >
		    		<include name="org/jbpm/**/*hbm.xml"/>
		        </fileset>
		     </schemaexport>
	    </target>

	<target name="ss-update-tables" depends="init" description="Update database tables for sitescape domain">
				<path id="initpath">
		  			<pathelement location="${classes.dir}"/>
					<fileset dir="${project.dir}/util" includes="*.jar"/>
					<fileset dir="${project.dir}/lib" includes="*.jar" />
				</path>
		        <taskdef classname="org.hibernate.tool.hbm2ddl.SchemaUpdateTask"
			             classpathref="initpath" name="schemaupdate">
		 		</taskdef> 

			    <schemaupdate 
	  					properties="${hibernate.dir}/ss-create-tables-hibernate.properties" 
			          	quiet="no" text="no">
			    	<fileset dir="${classes.dir}" >
			    		<include name="com/sitescape/ef/**/*hbm.xml"/>
			            <include name="com/sitescape/ef/security/**/*hbm.xml"/>
			        </fileset>
			     </schemaupdate>
		    </target>
			
	<target name="compile-test" depends="compile">
		<mkdir dir="${test.classes.dir}"/>
		<javac
			compiler="${javac.compiler}"
			debug="${javac.debug}"
			deprecation="${javac.deprecation}"
			destdir="${test.classes.dir}"
			fork="${javac.fork}"
			memoryMaximumSize="${javac.memoryMaximumSize}"
			nowarn="${javac.nowarn}"
			srcdir="${test.source.dir}">
			<classpath location="${test.classes.dir}"/>
			<classpath refid="project.classpath"/>
		</javac>
	</target>
	
	<!-- Note: You can run an individual test by setting test.includes property
	     at the command line. For example, 
	     ant test -Dtest.includes=**/CoreDaoImplTests.class
	     will run only CoreDaoImplTests and nothing else. -->
	<target name="unit-test" depends="compile-test">
		<mkdir dir="${test.report.dir}"/>
		<property name="tests" value="Test*"/>

		<junit printsummary="yes" haltonfailure="yes" haltonerror="yes" fork="yes">
			<classpath location="${test.classes.dir}"/>
			<classpath location="${test.source.dir}"/>
			<classpath refid="project.classpath"/>

			<formatter type="plain" usefile="false"/>
			<!--<formatter type="brief" usefile="false"/>-->
			<formatter type="xml"/>

			<batchtest todir="${test.report.dir}">
				<fileset dir="${test.classes.dir}" includes="${test.includes}" excludes="${test.excludes}"/>
			</batchtest>
		</junit>
	</target>
	
	<target name="unit-test-report" depends="init">
		<mkdir dir="${test.report.dir}/html"/>
		<junitreport todir="${test.report.dir}">
			<fileset dir="${test.report.dir}">
				<include name="TEST-*.xml"/>
			</fileset>
			<report todir="${test.report.dir}/html"/>
		</junitreport>
	</target>
	
</project>