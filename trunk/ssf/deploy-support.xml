<?xml version="1.0"?>

<project name="deploy-support">

	<target name="deploy-init">
		<echo message="##### DEPLOY-SUPPORT #####" />
		<propertycopy name="app.server.dir" from="app.server.${app.server.type}.dir" />
		<propertycopy name="app.server.bin.dir" from="app.server.${app.server.type}.bin.dir" />
		<propertycopy name="app.server.deploy.dir" from="app.server.${app.server.type}.deploy.dir" />
		<propertycopy name="app.server.lib.dir" from="app.server.${app.server.type}.lib.dir" />
	</target>
	
	<target name="deploy-ejb-jar" depends="deploy-init">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<equals arg1="${app.server.type}" arg2="tomcat" />
			</or>
			<then>
				<copy file="${deploy-support.jar.file}" todir="${app.server.lib.dir}" />
			</then>
			<else>
				<if>
					<not>
						<uptodate srcfile="${deploy-support.jar.file}" targetfile="${app.server.deploy.dir}/ext.ear/${deploy-support.jar.file}" />
					</not>
					<then>
						<delete dir="${app.server.deploy.dir}/ext.ear/${deploy-support.jar.file}" />
						<unjar src="${deploy-support.jar.file}" dest="${app.server.deploy.dir}/ext.ear/${deploy-support.jar.file}" />
					</then>
				</if>
			</else>
		</if>
	</target>
	
	
	<target name="deploy-jar" depends="deploy-init">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<equals arg1="${app.server.type}" arg2="rexip" />
				<equals arg1="${app.server.type}" arg2="tomcat" />
			</or>
			<then>
				<property name="ear.lib.dir" value="${app.server.lib.dir}" />
			</then>
			<else>
				<property name="ear.lib.dir" value="${app.server.deploy.dir}/ext.ear/lib" />
			</else>
		</if>
		<copy file="${deploy-support.jar.file}" todir="${ear.lib.dir}" />
	</target>
	
	<target name="deploy-war" depends="deploy-init">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<equals arg1="${app.server.type}" arg2="tomcat" />
			</or>
			<then>
				<if>
					<not>
						<uptodate srcfile="${deploy-support.war.context}-web.war" targetfile="${app.server.dir}/webapps/${deploy-support.war.context}" />
					</not>
					<then>
						<unjar src="${deploy-support.war.context}-web.war" dest="${app.server.dir}/webapps/${deploy-support.war.context}" />

						<java
							classname="com.liferay.portal.tools.WebXMLStripper"
							classpathref="project.classpath"
							fork="true"
							newenvironment="true"
						>
							<arg value="${app.server.dir}/webapps/${deploy-support.war.context}/WEB-INF/web.xml" />
						</java>
					</then>
				</if>
			</then>
			<else>
				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
						<equals arg1="${app.server.type}" arg2="jonas-jetty" />
						<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
						<equals arg1="${app.server.type}" arg2="rexip" />
						<equals arg1="${app.server.type}" arg2="weblogic" />
					</or>
					<then>
						<property name="deploy-support.war.file" value="${deploy-support.war.context}-web.war" />
					</then>
					<elseif>
						<or>
							<equals arg1="${app.server.type}" arg2="oc4j" />
							<equals arg1="${app.server.type}" arg2="orion" />
						</or>
						<then>
							<property name="deploy-support.war.file" value="${deploy-support.war.context}-web" />
						</then>
					</elseif>
				</if>

				<if>
					<not>
						<uptodate srcfile="${deploy-support.war.context}-web.war" targetfile="${app.server.deploy.dir}/ext.ear/${deploy-support.war.file}" />
					</not>
					<then>
						<unjar src="${deploy-support.war.context}-web.war" dest="${app.server.deploy.dir}/ext.ear/${deploy-support.war.file}" />
					</then>
				</if>

				<if>
					<equals arg1="${app.server.type}" arg2="jonas-jetty" />
					<then>
						<copy file="${app.server.deploy.dir}/ext.ear/${deploy-support.war.file}/WEB-INF/web-jetty.xml.JOnAS_Jetty" tofile="${app.server.deploy.dir}/ext.ear/${deploy-support.war.file}/WEB-INF/web-jetty.xml" overwrite="yes" failonerror="false" />
					</then>
				</if>

				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jonas-jetty" />
						<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
					</or>
					<then>
						<replace file="${app.server.deploy.dir}/ext.ear/${deploy-support.war.file}/WEB-INF/web.xml">
							<replacetoken><![CDATA[<ejb-link>com_liferay_]]></replacetoken>
							<replacevalue><![CDATA[<ejb-link>ssf-main.jar#com_liferay_]]></replacevalue>
						</replace>
					</then>
				</if>

				<copy todir="${app.server.deploy.dir}/ext.ear">
					<fileset dir="${project.dir}/ear/modules" includes="META-INF/*.xml" />
				</copy>

				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jonas-jetty" />
						<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
					</or>
					<then>
						<replace file="${app.server.deploy.dir}/ext.ear/META-INF/application.xml">
							<replacetoken><![CDATA[
	<module>
		<web>
			<web-uri>${deploy-support.war.context}-web.war</web-uri>
			<context-root>/${deploy-support.war.context}</context-root>
		</web>
	</module>]]></replacetoken>
							<replacevalue></replacevalue>
						</replace>
					</then>
				</if>
			</else>
		</if>
	</target>

	<target name="deploy-applet" depends="deploy-init">		
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<equals arg1="${app.server.type}" arg2="tomcat" />
			</or>
			<then>
				<copy file="${deploy-support.jar.file}" todir="${app.server.deploy.dir}/${deploy-support.applet.deploy.dir}" />
			</then>
			<else>
				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
						<equals arg1="${app.server.type}" arg2="jonas-jetty" />
						<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
						<equals arg1="${app.server.type}" arg2="rexip" />
						<equals arg1="${app.server.type}" arg2="weblogic" />
					</or>
					<then>
						<property name="deploy-support.war.file" value="ssf-web-complete.war" />
					</then>
					<elseif>
						<or>
							<equals arg1="${app.server.type}" arg2="oc4j" />
							<equals arg1="${app.server.type}" arg2="orion" />
						</or>
						<then>
							<property name="deploy-support.war.file" value="ssf-web-complete" />
						</then>
					</elseif>
				</if>
				
				<copy file="${deploy-support.jar.file}" todir="${app.server.deploy.dir}/ext.ear/${deploy-support.war.file}/${deploy-support.applet.deploy.dir}" />

			</else>
		</if>
	</target>

</project>