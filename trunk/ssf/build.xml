<?xml version="1.0"?>

<project name="ssf" basedir="." default="compile">
	<target name="init-app-server">
		<property environment="env" />
  		<property file="app.server.${user.name}.properties" />
  		<property file="app.server.properties" />
		<taskdef resource="net/sf/antcontrib/antcontrib.properties">
			<classpath>
				<pathelement location="lib/ant-contrib.jar" />
			</classpath>
		</taskdef>
		<propertycopy name="app.server.dir" from="app.server.${app.server.type}.dir" />
		<propertycopy name="app.server.lib.dir" from="app.server.${app.server.type}.lib.dir" />
		<propertycopy name="app.server.deploy.dir" from="app.server.${app.server.type}.deploy.dir" />
		<propertycopy name="app.server.ssf.dir" from="app.server.${app.server.type}.ssf.dir" />
	</target>

	<target name="init-build">
		<property environment="env" />
  		<property file="build.${user.name}.properties" />
  		<property file="build.properties" />
	</target>

	<target name="init-release">
		<property environment="env" />
  		<property file="release.${user.name}.properties" />
  		<property file="release.properties" />
	</target>

	<target name="all" depends="clean,build,deploy-liferay" />

	<target name="all-without-clean" depends="build,deploy-liferay" />

	<target name="build">
		<antcall target="compile" />
		<antcall target="jar" />
	</target>

	<target name="clean">
		<delete dir="${tmp.dir}" />
		<delete dir="liferay/temp" />
		
		<ant dir="util" target="clean" />
		<ant dir="indexer-lucene" target="clean" />
		<ant dir="remoting" target="clean" />

		<ant dir="applets" target="clean" />

		<ant dir="main" target="clean" />
		<ant dir="portal-module" target="clean" />
		<ant dir="liferay" target="clean" />
		<ant dir="taglib" target="clean" />

		<ant dir="web" target="clean" />

		<ant dir="war" target="clean" />
		
		<ant dir="slide" target="clean" />
	</target>

	<target name="compile">
		<ant dir="util" target="compile" />
		<ant dir="indexer-lucene" target="compile" />			
		<ant dir="remoting" target="compile" />			

		<ant dir="main" target="compile-common" />

		<ant dir="applets" target="compile" />

		<ant dir="main" target="compile" />

		<ant dir="portal-module" target="compile" />
		<ant dir="liferay" target="compile" />
		<ant dir="taglib" target="compile" />
	</target>

	<target name="jar">
		<ant dir="util" target="jar" />
		<ant dir="indexer-lucene" target="jar" />
		<ant dir="remoting" target="jar" />

		<ant dir="applets" target="jar" />

		<ant dir="main" target="compile-common" />
		<ant dir="main" target="jar" />
		<ant dir="portal-module" target="jar" />
		<ant dir="liferay" target="jar" />
		<ant dir="taglib" target="jar" />

		<ant dir="web" target="war" />

		<ant dir="war" target="war" />
		
		<ant dir="slide" target="war" />
	</target>

	<target name="java2html">
		<delete dir="${api.dir}" />

		<ant dir="util" target="java2html" />
		<ant dir="indexer-lucene" target="java2html" />
		<ant dir="remoting" target="java2html" />

		<ant dir="applets" target="java2html" />

		<ant dir="main" target="java2html" />
		<ant dir="indexer-lucene" target="java2html" />
		<ant dir="portal-module" target="java2html" />
		<ant dir="liferay" target="java2html" />
		<ant dir="taglib" target="java2html" />
	</target>

	<target name="javadoc">
		<delete dir="${api.dir}" />

		<ant dir="util" target="javadoc" />
		<ant dir="indexer-lucene" target="javadoc" />
		<ant dir="remoting" target="javadoc" />
		
		<ant dir="applets" target="javadoc" />

		<ant dir="main" target="javadoc" />
		<ant dir="indexer-lucene" target="javadoc" />
		<ant dir="portal-module" target="javadoc" />
		<ant dir="liferay" target="javadoc" />
		<ant dir="taglib" target="javadoc" />
	</target>

	<target name="clean-app-server" depends="init-app-server">
		<delete>
			<fileset dir="${app.server.lib.dir}" includes="ssf-*.jar" />
		</delete>		
		
		<delete dir="${app.server.deploy.dir}/ssf"/>
	</target>
	
	<target name="init-liferay" depends="init-app-server,init-build">
		<if>
			<equals arg1="${app.server.type}" arg2="tomcat" />
			<then>
				<path id="deploy.liferay.classpath">
					<pathelement location="${env.ANT_HOME}/lib/ant.jar" />
					<fileset dir="${app.server.lib.dir}" />
					<pathelement location="${app.server.dir}/common/lib/servlet-api.jar" />
				</path>
				<property name="deploy.liferay.webinf" value="${app.server.dir}/liferay/WEB-INF" />
				<property name="deploy.liferay.lib.dir" value="${app.server.lib.dir}" />
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				<then>
					<path id="deploy.liferay.classpath">
						<pathelement location="${app.server.deploy.dir}/ext.ear/portal-ejb.jar" />
						<pathelement location="${env.ANT_HOME}/lib/ant.jar" />
						<fileset dir="${app.server.deploy.dir}/ext.ear/lib" />
						<pathelement location="${app.server.deploy.dir}/../lib/javax.servlet.jar" />
					</path>
					<property name="deploy.liferay.webinf" value="${app.server.deploy.dir}/ext.ear/portal-web-complete.war/WEB-INF" />
					<property name="deploy.liferay.lib.dir" value="${app.server.deploy.dir}/ext.ear/lib" />
				</then>
			</elseif>
		</if>	
		<property name="deploy.liferay.portlet.tld" value="${deploy.liferay.webinf}/tld/liferay-portlet.tld" />
		<property name="deploy.liferay.taglib.jar" value="${deploy.liferay.webinf}/lib/util-taglib.jar" />
		<property name="deploy.liferay.util.jar" value="${deploy.liferay.lib.dir}/util-java.jar" />
	</target>
	
	<target name="deploy-liferay" depends="init-app-server,init-build">
		<if>
			<equals arg1="${app.server.type}" arg2="tomcat" />
			<then>
				<antcall target="deploy-liferay-tomcat" />
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				<then>
					<antcall target="deploy-liferay-jboss-tomcat" />
				</then>
			</elseif>
		</if>
	</target>
	
	<target name="deploy-liferay-pre">
		<delete>
			<fileset dir="${app.server.lib.dir}" includes="ssf-*.jar" />
		</delete>		
		
		<delete dir="liferay/temp" />

		<copy file="war/ssf.war" todir="liferay/temp" />		
	</target>
	
	<target name="deploy-liferay-post">
		<ant dir="portal-module" target="deploy" />
		<ant dir="liferay" target="deploy" />
	</target>
		
	<target name="deploy-liferay-tomcat" depends="init-liferay">
		<antcall target="deploy-liferay-pre" />
		
		<java
			classname="com.liferay.portal.tools.PortletDeployer"
			classpathref="deploy.liferay.classpath"
			fork="true"
			newenvironment="true">

				<!-- Required Arguments -->

				<jvmarg value="-Ddeployer.base.dir=liferay/temp/" />
				<jvmarg value="-Ddeployer.dest.dir=${app.server.deploy.dir}" />
				<jvmarg value="-Ddeployer.app.server.type=${app.server.type}" />
				<jvmarg value="-Ddeployer.portlet.taglib.dtd=${deploy.liferay.portlet.tld}" />

				<!-- Optional Arguments -->

				<jvmarg value="-Ddeployer.jboss.prefix=1" />
				<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.dir}/common/lib/ext" />

				<!-- Dependent Libraries -->

				<arg value="${deploy.liferay.taglib.jar}" />
				<arg value="${deploy.liferay.util.jar}" />
				<!--<arg value="${app.server.deploy.dir}/ext.ear/lib/util-jsf.jar" />-->
		</java>

		<antcall target="deploy-liferay-post" />
		<ant dir="slide" target="deploy" />
		
		<copy file="tomcat/resources/ssf.xml" todir="${app.server.dir}/conf/Catalina/localhost" />		
		<copy file="tomcat/resources/server.slide.xml" tofile="${app.server.dir}/conf/server.xml" />		
		<copy file="liferay/resources/web.tomcat.ssf.xml" tofile="${deploy.liferay.webinf}/web.xml" />
		<copy file="tomcat/resources/jaas.liferay.slide.config" tofile="${app.server.dir}/conf/jaas.config" />
		<copy file="lib/portal-ejb.jar" todir="${deploy.liferay.lib.dir}" />
		<!-- Copy jdom.jar file into our lib directory because jakarta Slide 
		     requires jdom 1.0 while the version of the Liferay we deploy
		     onto contains earlier version (beta 8?) of jdom. We should remove
		     this line once we upgarde to a later version of Liferay that contains
		     v1.0 of jdom. -->
		<copy file="lib/jdom.jar" todir="${app.server.ssf.dir}/WEB-INF/lib" />
		<copy file="lib/xalan.jar" todir="${app.server.dir}/common/endorsed" />
	</target>
		
	<target name="deploy-liferay-jboss-tomcat" depends="init-liferay">	
		<antcall target="deploy-liferay-pre" />
		
		<java
			classname="com.liferay.portal.tools.PortletDeployer"
			classpathref="deploy.liferay.classpath"
			fork="true"
			newenvironment="true">

				<!-- Required Arguments -->

				<jvmarg value="-Ddeployer.base.dir=liferay/temp/" />
				<jvmarg value="-Ddeployer.dest.dir=${app.server.deploy.dir}" />
				<jvmarg value="-Ddeployer.app.server.type=${app.server.type}" />
				<jvmarg value="-Ddeployer.portlet.taglib.dtd=${deploy.liferay.portlet.tld}" />

				<!-- Optional Arguments -->

				<jvmarg value="-Ddeployer.jboss.prefix=1" />
				<!--<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.dir}/common/lib/ext" />-->

				<!-- Dependent Libraries -->

				<arg value="${deploy.liferay.taglib.jar}" />
				<arg value="${deploy.liferay.util.jar}" />
				<!--<arg value="${app.server.deploy.dir}/ext.ear/lib/util-jsf.jar" />-->
		</java>
		
		<antcall target="deploy-liferay-post" />
		
		<!-- For SSF -->
		<copy file="jboss/resources/ssf-ds.xml" todir="${app.server.deploy.dir}" />		
		<copy file="jboss/resources/mail-service.liferay.ssf.xml" tofile="${app.server.deploy.dir}/mail-service.xml" />		
		<!-- For Slide -->
		<!--<copy file="jboss/resources/server.slide.xml" tofile="${app.server.deploy.dir}/jbossweb-tomcat55.sar/server.xml" />-->
		<!--<copy file="jboss/resources/login-config.slide.xml" tofile="${app.server.dir}/server/default/conf/login-config.xml" />-->
		<!--<move file="${app.server.deploy.dir}/slide.war/WEB-INF/lib/slide-jaas-2.1.jar" todir="${app.server.dir}/server/default/lib" failonerror="false" />-->
		<!-- For Liferay -->
		<copy file="liferay/resources/web.jboss.ssf.xml" tofile="${deploy.liferay.webinf}/web.xml" />
		<copy file="liferay/resources/portal.jboss.ssf.properties" tofile="${app.server.deploy.dir}/ext.ear/portal-ejb.jar/portal.properties" />
		<copy file="liferay/resources/MANIFEST.jboss.ssf.MF" tofile="${app.server.deploy.dir}/ext.ear/portal-web-complete.war/META-INF/MANIFEST.MF" />
	</target>
		
	<target name="zip">
		<antcall target="zip-api" />
		<!--<antcall target="zip-src" />-->
		<antcall target="zip-war" />
  		<ant dir="indexer-lucene" target="zip" />
  		<ant dir="stellent" target="zip" />
	</target>

	<target name="zip-api" depends="init-release">
		<delete file="sitescape-forum-${ssf.version}-doc.zip" failonerror="false" />
		<zip zipfile="sitescape-forum-${ssf.version}-doc.zip"
			basedir="."
			includes="api/**/*.css,api/**/*.gif,api/**/*.html"
		/>
	</target>

	<target name="zip-src" depends="init-release">
		<delete file="sitescape-forum-${ssf.version}-src.zip" failonerror="false" />
		<zip zipfile="sitescape-forum-${ssf.version}-src.zip"
			basedir="${ssf.source.dir}"
			excludes="**/CVS/**,**/*.scc"
		/>
	</target>

	<target name="zip-war" depends="init-release">
		<delete file="sitescape-forum-${ssf.version}-war.zip" failonerror="false" />
		<zip zipfile="sitescape-forum-${ssf.version}-war.zip"
			basedir="war"
			includes="ssf.war"
		/>
		<zip zipfile="sitescape-forum-${ssf.version}-war.zip"
			basedir="slide"
			includes="slide.war"
			update="true"
		/>
	</target>

	<target name="release" depends="init-release">
		<!--
		<delete>
			<fileset dir="${ssf.source.dir}" defaultexcludes="no">
				<include name="**/.#*" />
			</fileset>
		</delete>
		-->

		<antcall target="clean" />
		<antcall target="build" />
		<!--<antcall target="java2html" />-->
		<antcall target="javadoc" />
		<antcall target="zip" />
	</target>

	<target name="tcpmon" description="Run Apache Axis tcpmon utility">
		<java classname="org.apache.axis.utils.tcpmon" fork="true" failonerror="true">
			<arg value="8079"/> 		<!-- Listen port tcpmon is monitoring -->
			<arg value="localhost"/>	<!-- Target host to forward to --> 
			<arg value="8080"/>			<!-- Target port to forward to -->
			<classpath>
				<pathelement location="lib/axis.jar" />
				<pathelement location="lib/axis-ant.jar" />
			</classpath>
		</java>
	</target>

	<target name="test" description="Run unit tests">
  		<ant dir="main" target="test" />
	</target>
	
</project>