<?xml version="1.0"?>

<project name="ssfs" basedir="." default="war">
	<import file="../build-common.xml" />
    <import file="../deploy-support.xml" />
	
	<property name="jar.file" value="ssf-ssfs.jar" />

	<property name="slide.war.file" value="slide.war" />
	<property name="output.war.name" value="ssfs" />
	<property name="output.war.file" value="${output.war.name}.war" />
	<property name="temp.dir" value="temp" />

	<target name="delete-temp">
		<delete includeemptydirs="true" dir="${temp.dir}" failonerror="true"/>
	</target>
	
	<target name="clean" depends="build-common.clean, delete-temp">
		<delete>
			<fileset dir="." includes="${output.war.file}" />
		</delete>
		<delete file="resources/slide-war/WEB-INF/jboss-web.xml" />
		<delete file="resources/slide-war/WEB-INF/web.xml" />
	</target>
		
	<target name="jar" depends="compile,build-common.jar">
		<jar 
			jarfile="${jar.file}"
			update="true"
		>
			<fileset dir="${basedir}/../main/classes">
	        	<include name="com/sitescape/team/ssfs/CrossContextConstants.class"/>
				<include name="com/sitescape/team/ssfs/AlreadyExistsException.class"/>
				<include name="com/sitescape/team/ssfs/NoAccessException.class"/>
				<include name="com/sitescape/team/ssfs/NoSuchObjectException.class"/>
				<include name="com/sitescape/team/ssfs/LockException.class"/>
				<include name="com/sitescape/team/ssfs/TypeMismatchException.class"/>
	        	<include name="com/sitescape/team/web/util/AttributesAndParamsOnlyServletRequest.class"/>
	        	<include name="com/sitescape/team/web/util/NullServletResponse.class"/>
			</fileset>
		</jar>
		<jar 
			jarfile="${jar.file}"
			update="true"
		>
			<fileset dir="${basedir}/../util/classes">
	        	<include name="com/sitescape/util/ServerDetector.class"/>
			</fileset>
		</jar>
		<antcall target="jar-manifest">
			<param name="jar-manifest.jar.file" value="${jar.file}"/>
		</antcall>
	</target>

	<target name="unwar-patched-slide-war" depends="delete-temp">		
		<unwar src="resources/${slide.war.file}" dest="${temp.dir}"/>
	</target>
	
	<target name="apply-changes" depends="jar,unwar-patched-slide-war,make-jboss-web.xml,make-web.xml">
		<!-- The following archives and files are not needed by SSFS. -->
		<delete failonerror="true">
			<fileset dir="${temp.dir}/WEB-INF/lib">
				<include name="ant.jar"/>
				<include name="commons-dbcp*.jar"/>
				<include name="commons-httpclient.jar"/>
				<include name="db-ojb*.jar"/>
				<include name="jakarta-slide-webdavlib*.jar"/>
				<include name="lucene*.jar"/>
				<include name="PDFBox*.jar"/>
				<include name="tm-extractors*.jar"/>
				<include name="tm-extractors.notice"/>
			</fileset>
		</delete>
		<copy todir="${temp.dir}" overwrite="true">
			<fileset dir="resources/slide-war" excludes="WEB-INF/jboss-web.xml.tmpl,WEB-INF/web.xml.tmpl,WEB-INF/context.xml" />
		</copy>
		<if>
			<equals arg1="${portal.type}" arg2="liferay" />
			<then>
				<copy file="resources/slide-war/WEB-INF/context.xml" todir="${temp.dir}" overwrite="true"/>
			</then>
		</if>
		<copy file="${jar.file}" todir="${temp.dir}/WEB-INF/lib" />
	</target>
	
	<target name="war" depends="apply-changes">		
		<war
			basedir="${temp.dir}"
			destfile="${output.war.file}"
			webxml="${temp.dir}/WEB-INF/web.xml"
			update="false"
		/>
	</target>
	
    <target name="deploy" depends="war">
        <antcall target="deploy-war">
        	<param name="deploy-support.war.name" value="${output.war.name}" />
        </antcall>
		<if>
			<equals arg1="${app.server.type}" arg2="tomcat" />
			<then>
				<!-- On Tomcat, Liferay's archives are deployed in common directory.
				     Delete the following jar files from ssfs so that it uses the
				     ones deployed with Liferay. Otherwise, it becomes problematic. -->
				<!-- With 4.1.2, Liferay's archives are no longer deployed in the 
				     server's common area. So we no longer need to delete the 
				     following archives. -->
				<!--<delete>
					<fileset dir="${app.server.ssfs.dir}/WEB-INF/lib">
						<include name="commons-logging-*.jar"/>
						<include name="log4j-*.jar"/>
					</fileset>
				</delete>-->
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				<then>
					<!-- JBoss does not allow applications to load their own commons logging
					     classes. They must use the shared one that JBoss already has. 
					     The same is also true with log4j archive. -->
					<delete>
						<fileset dir="${app.server.deploy.dir}/ssfs.war/WEB-INF/lib" includes="commons-logging*.jar"/>
						<fileset dir="${app.server.deploy.dir}/ssfs.war/WEB-INF/lib" includes="log4j*.jar"/>
					</delete>		
				</then>
			</elseif>
		</if>
    </target>

	<target name="make-web.xml">
		<if>
			<equals arg1="${portal.type}" arg2="liferay" />
			<then>
				<delete file="resources/slide-war/WEB-INF/web.xml" />
				<copy file="resources/slide-war/WEB-INF/web.xml.tmpl" tofile="resources/slide-war/WEB-INF/web.xml" />
				<replace 
					file="resources/slide-war/WEB-INF/web.xml" 
					propertyFile="replace.properties">
					<replacefilter 
						token="@@SECURITY_ROLE_REF@@"
						property="liferay.*.web.security.role.ref"/>
					<replacefilter 
						token="@@AUTH_CONSTRAINT@@"
						property="liferay.*.web.auth.constraint"/>
					<replacefilter 
						token="@@REALM_NAME@@"
						property="liferay.*.web.realm-name"/>
					<replacefilter 
						token="@@SECURITY_ROLE@@"
						property="liferay.*.web.security.role"/>
				</replace>
			</then>
			<elseif>
				<equals arg1="${portal.type}" arg2="jbossportal" />
				<then>
					<delete file="resources/slide-war/WEB-INF/web.xml" />
					<copy file="resources/slide-war/WEB-INF/web.xml.tmpl" tofile="resources/slide-war/WEB-INF/web.xml" />
					<replace 
						file="resources/slide-war/WEB-INF/web.xml" 
						propertyFile="replace.properties">
						<replacefilter 
							token="@@SECURITY_ROLE_REF@@"
							property="jbossportal.jbosstomcat.web.security.role.ref"/>
						<replacefilter 
							token="@@AUTH_CONSTRAINT@@"
							property="jbossportal.jbosstomcat.web.auth.constraint"/>
						<replacefilter 
							token="@@REALM_NAME@@"
							property="jbossportal.jbosstomcat.web.realm-name"/>
						<replacefilter 
							token="@@SECURITY_ROLE@@"
							property="jbossportal.jbosstomcat.web.security.role"/>
					</replace>
				</then>
			</elseif>
		</if>	
	</target>

	<target name="make-jboss-web.xml">
		<if>
			<equals arg1="${portal.type}" arg2="liferay" />
			<then>
				<delete file="resources/slide-war/WEB-INF/jboss-web.xml" />
				<copy file="resources/slide-war/WEB-INF/jboss-web.xml.tmpl" tofile="resources/slide-war/WEB-INF/jboss-web.xml" />
				<replace 
					file="resources/slide-war/WEB-INF/jboss-web.xml" 
					propertyFile="replace.properties">
					<replacefilter 
						token="@@SECURITY_DOMAIN@@"
						property="liferay.*.jbossweb.security.domain"/>
				</replace>
			</then>
			<elseif>
				<equals arg1="${portal.type}" arg2="jbossportal" />
				<then>
					<delete file="resources/slide-war/WEB-INF/jboss-web.xml" />
					<copy file="resources/slide-war/WEB-INF/jboss-web.xml.tmpl" tofile="resources/slide-war/WEB-INF/jboss-web.xml" />
					<replace 
						file="resources/slide-war/WEB-INF/jboss-web.xml" 
						propertyFile="replace.properties">
						<replacefilter 
							token="@@SECURITY_DOMAIN@@"
							property="jbossportal.jbosstomcat.jbossweb.security.domain"/>
					</replace>
				</then>
			</elseif>
		</if>	
	</target>

</project>